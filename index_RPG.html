<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>2D 像素 RPG 屬性版</title>
<style>
body { background:#111; display:flex; justify-content:center; }
canvas { image-rendering: pixelated; margin-top:20px; }
#battleUI, #dialogUI { position:absolute; top:50px; left:50%; transform:translateX(-50%);
  width:300px; padding:15px; background:#222; color:white; border:2px solid white;
  display:none;
}
button { margin-top:10px; width:100%; padding:10px; }
#playerStats { position:absolute; top:10px; left:10px; color:white; }
#expBar { position:absolute; top:35px; left:10px; width:200px; height:10px; background:#444; }
#expBarFill { width:0%; height:100%; background:#ff0; }
</style>
</head>
<body>

<canvas id="game" width="640" height="640"></canvas>
<div id="playerStats"></div>
<div id="expBar"><div id="expBarFill"></div></div>

<div id="battleUI">
  <h3 id="monsterName"></h3>
  <p id="monsterHP"></p>
  <button id="attackBtn">普通攻擊</button>
  <button id="skillBtn">技能攻擊</button>
</div>

<div id="dialogUI">
  <p id="dialogText"></p>
  <button id="closeDialogBtn">關閉</button>
</div>

<script>
//========================
// 基本設定
//========================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let tileSize=32, mapSize=20;

// 圖像載入
let playerImg = new Image(); playerImg.src="player.png";
let slimeImg = new Image(); slimeImg.src="slime.png";
let goblinImg = new Image(); goblinImg.src="goblin.png";
let orcImg = new Image(); orcImg.src="orc.png";
let npcImg = new Image(); npcImg.src="npc.png";
let tileGrass = new Image(); tileGrass.src="tile_grass.png";
let tileTree = new Image(); tileTree.src="tile_tree.png";
let tileHouse = new Image(); tileHouse.src="tile_house.png";

// 屬性 & 技能名稱
const elements=["fire","water","wind","earth","light","dark"];
const skillNames={
  fire:"地獄業火", water:"深淵潮噬", wind:"颶風裂空",
  earth:"大地崩裂", light:"聖光審判", dark:"暗影烈焰"
};

function isEffective(att,def){
  const strongAgainst={fire:"wind", water:"fire", wind:"earth", earth:"light", light:"dark", dark:"light"};
  return strongAgainst[att]===def;
}

// 玩家選擇職業與屬性
let player={};
let job=prompt("選職業：1戰士 2法師","1");
let ele=prompt("選屬性：fire water wind earth light dark","fire");
player={x:5,y:5,hp:120,atk:15,skillAtk:25,color:"#ffff00",job:job==="1"?"戰士":"法師",exp:0,level:1,weapon:0,armor:0,element:ele};

// 怪物設定
const monsters=[
  {name:"史萊姆", hp:30, atk:5, element:"water", img:slimeImg, exp:10},
  {name:"哥布林", hp:50, atk:8, element:"earth", img:goblinImg, exp:20},
  {name:"半獸人", hp:80, atk:12, element:"fire", img:orcImg, exp:40}
];
let currentMonster=null;

// NPC
const npcs=[
  {x:10,y:3,name:"村長", dialog:["勇者！幫我打倒3隻史萊姆！"], quest:{type:"kill",target:"史萊姆",count:3,progress:0,reward:{exp:30,weapon:5}}}
];

// 地圖生成 (0:草,1:樹,2:房)
let map=[];
for(let y=0;y<mapSize;y++){
  map[y]=[];
  for(let x=0;x<mapSize;x++){
    let r=Math.random();
    map[y][x]=r<0.1?2:r<0.3?1:0;
  }
}

//========================
// 繪圖
//========================
let skillAnimations=[];
function drawSkillAnimations(){
  skillAnimations.forEach((s,i)=>{
    s.y-=2; s.frame++;
    ctx.fillStyle=`rgba(255,0,0,${1-s.frame/20})`;
    ctx.beginPath(); ctx.arc(s.x+tileSize/2,s.y+tileSize/2,s.size,0,Math.PI*2); ctx.fill();
    if(s.frame>20) skillAnimations.splice(i,1);
  });
}

function drawMap(){
  for(let y=0;y<mapSize;y++){
    for(let x=0;x<mapSize;x++){
      let img=map[y][x]===0?tileGrass:map[y][x]===1?tileTree:tileHouse;
      ctx.drawImage(img,x*tileSize,y*tileSize,tileSize,tileSize);
    }
  }
}

function drawPlayer(){ ctx.drawImage(playerImg,player.x*tileSize,player.y*tileSize,tileSize,tileSize);}
function drawMonster(mon){ ctx.drawImage(mon.img,mon.x*tileSize,mon.y*tileSize,tileSize,tileSize);}
function drawNPC(npc){ ctx.drawImage(npcImg,npc.x*tileSize,npc.y*tileSize,tileSize,tileSize);}

function draw(){
  ctx.clearRect(0,0,640,640);
  drawMap();
  drawPlayer();
  npcs.forEach(drawNPC);
  if(currentMonster && currentMonster.inBattle) drawMonster(currentMonster);
  if(skillAnimations.length>0) drawSkillAnimations();
  requestAnimationFrame(draw);
}
draw();

//========================
// 狀態更新
//========================
function updatePlayerStats(){
  document.getElementById("playerStats").textContent=`職業:${player.job} LV:${player.level} HP:${player.hp} 武器:${player.weapon} 防具:${player.armor} 屬性:${player.element}`;
  document.getElementById("expBarFill").style.width=(player.exp%100)+"%";
}
updatePlayerStats();

//========================
// 戰鬥
//========================
function startBattle(monster){
  currentMonster=JSON.parse(JSON.stringify(monster));
  currentMonster.x=monster.x||Math.floor(Math.random()*mapSize);
  currentMonster.y=monster.y||Math.floor(Math.random()*mapSize);
  currentMonster.inBattle=true;
  document.getElementById("monsterName").textContent="遇到："+currentMonster.name+" 屬性："+currentMonster.element;
  document.getElementById("monsterHP").textContent="HP："+currentMonster.hp;
  document.getElementById("battleUI").style.display="block";
}

document.getElementById("attackBtn").onclick=()=>{dealDamage(player.atk,false);}
document.getElementById("skillBtn").onclick=()=>{dealDamage(player.skillAtk,true);}

function dealDamage(dmg,isSkill){
  if(isSkill){
    alert("使用技能："+skillNames[player.element]+"！");
    skillAnimations.push({x:player.x*tileSize,y:player.y*tileSize,size:10,frame:0});
    if(isEffective(player.element,currentMonster.element)) dmg*=1.5;
  }
  currentMonster.hp-=dmg;
  if(currentMonster.hp<=0){
    alert("你打敗了 "+currentMonster.name+"！");
    player.exp+=currentMonster.exp;
    checkLevelUp();
    document.getElementById("battleUI").style.display="none";
    currentMonster=null;
    updatePlayerStats();
    checkQuestProgress();
    return;
  }
  player.hp-=Math.max(0,currentMonster.atk-player.armor);
  if(player.hp<=0){ alert("你被打敗了！遊戲結束"); location.reload();}
  document.getElementById("monsterHP").textContent="HP："+currentMonster.hp;
  updatePlayerStats();
}

function checkLevelUp(){
  while(player.exp>=player.level*100){
    player.exp-=player.level*100;
    player.level++;
    player.hp+=20;
    player.atk+=5;
    player.skillAtk+=10;
    alert("升級了！現在等級:"+player.level);
  }
}

// 任務系統
function checkQuestProgress(){
  npcs.forEach(npc=>{
    if(npc.quest && currentMonster){
      if(currentMonster.name===npc.quest.target){
        npc.quest.progress++;
        if(npc.quest.progress>=npc.quest.count){
          alert("任務完成！獲得經驗:"+npc.quest.reward.exp+" 武器:"+npc.quest.reward.weapon);
          player.exp+=npc.quest.reward.exp;
          player.weapon+=npc.quest.reward.weapon;
          npc.quest=null;
          updatePlayerStats();
        }
      }
    }
  });
}

// NPC 對話
function interactNPC(){
  npcs.forEach(npc=>{
    if(Math.abs(player.x-npc.x)<=1 && Math.abs(player.y-npc.y)<=1){
      document.getElementById("dialogText").textContent=npc.dialog[0];
      document.getElementById("dialogUI").style.display="block";
    }
  });
}
document.getElementById("closeDialogBtn").onclick=()=>{document.getElementById("dialogUI").style.display="none";}

//========================
// 移動與遇怪
//========================
document.addEventListener("keydown",(e)=>{
  if(document.getElementById("battleUI").style.display==="block") return;
  if(document.getElementById("dialogUI").style.display==="block") return;

  let moved=false;
  if(e.key==="ArrowUp"){player.y--;moved=true;}
  if(e.key==="ArrowDown"){player.y++;moved=true;}
  if(e.key==="ArrowLeft"){player.x--;moved=true;}
  if(e.key==="ArrowRight"){player.x++;moved=true;}

  player.x=Math.max(0,Math.min(mapSize-1,player.x));
  player.y=Math.max(0,Math.min(mapSize-1,player.y));

  if(moved && Math.random()<0.1) startBattle(monsters[Math.floor(Math.random()*monsters.length)]);
  if(e.key===" ") interactNPC();
});
</script>
</body>
</html>


