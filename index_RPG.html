<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pixel RPG</title>
<style>
  body { margin:0; background:#000; overflow:hidden; }
  canvas { background:#222; display:block; margin:0 auto; }
  #ui { position:fixed; top:10px; left:10px; color:#fff; font-family:sans-serif; }
  #regionMenu { position:fixed; top:10px; right:10px; background:#333; padding:10px; border-radius:6px; color:#fff; font-family:sans-serif; }
  button { margin:3px; }
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
  <div>HP: <span id="hp"></span></div>
  <div>MP: <span id="mp"></span></div>
  <div>金幣: <span id="gold"></span></div>
  <div>EXP: <span id="exp"></span></div>
  <button onclick="useSkill()">使用技能：地獄業火</button>
  <button onclick="drawGacha()">抽卡</button>
</div>

<div id="regionMenu">
  <div style="font-weight:bold;">切換區域</div>
  <button onclick="changeArea('village')">村莊</button>
  <button onclick="changeArea('forest')">森林</button>
  <button onclick="changeArea('desert')">沙漠</button>
  <button onclick="changeArea('swamp')">沼澤</button>
  <button onclick="changeArea('dungeon')">地城</button>
</div>

<script>
/*-----------------------------------------------------------
  基本設定
-----------------------------------------------------------*/
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let keys = {};

const player = {
  x: 480, y: 270, w: 24, h: 24,
  hp: 100, mp: 50, maxMP: 50, mpRegen: 0.05,
  speed: 2
};

const AREAS = {
  village: { color:"#3a5", name:"村莊", buildings:[], npcs:[] },
  forest:  { color:"#064", name:"森林", },
  desert:  { color:"#bba456", name:"沙漠"},
  swamp:   { color:"#204020", name:"沼澤"},
  dungeon: { color:"#333", name:"地城"}
};

let currentArea = AREAS.village;

/*-----------------------------------------------------------
  建築物 & NPC (像素風)
-----------------------------------------------------------*/
function initVillage(){
  currentArea.buildings = [
    { x:150, y:200, w:120, h:80, color:"#754c24", name:"武器店" },
    { x:350, y:180, w:140, h:90, color:"#666", name:"冒險者公會" },
    { x:600, y:210, w:100, h:70, color:"#8844aa", name:"抽卡屋" }
  ];

  currentArea.npcs = [
    { x:190, y:260, w:16, h:16, color:"#fffbe0", name:"武器店店員" },
    { x:400, y:260, w:16, h:16, color:"#ffddcc", name:"公會接待員" },
    { x:630, y:260, w:16, h:16, color:"#ffeeff", name:"抽卡店老闆" }
  ];
}
initVillage();

/*-----------------------------------------------------------
  怪物設定
-----------------------------------------------------------*/
const monsterTypes = [
  {name:"史萊姆", color:"#5af", hp:20, atk:2},
  {name:"哥布林", color:"#6a4", hp:35, atk:4},
  {name:"半獸人", color:"#a63", hp:60, atk:6},
  {name:"蜥人",   color:"#3a8", hp:50, atk:5},
  {name:"鬼",     color:"#aaa", hp:70, atk:7},
  {name:"精靈",   color:"#fff", hp:30, atk:4}
];

let enemies = [];

/*-----------------------------------------------------------
  生成怪物（非村莊）
-----------------------------------------------------------*/
function spawnEnemies(){
  enemies = [];
  if(currentArea === AREAS.village) return;
  for(let i=0;i<5;i++){
    const m = monsterTypes[Math.floor(Math.random()*monsterTypes.length)];
    enemies.push({
      x: Math.random()*800+80,
      y: Math.random()*400+60,
      w:20, h:20,
      hp: m.hp,
      maxHP: m.hp,
      name: m.name,
      lvl: Math.floor(Math.random()*5)+1,
      color: m.color
    });
  }
}

/*-----------------------------------------------------------
  地區切換
-----------------------------------------------------------*/
function changeArea(areaName){
  currentArea = AREAS[areaName];
  player.x = 480;
  player.y = 270;
  spawnEnemies();
}

/*-----------------------------------------------------------
  抽卡
-----------------------------------------------------------*/
let gold = 0;
function drawGacha(){
  if(gold < 50){
    alert("金幣不足（需要 50）");
    return;
  }
  gold -= 50;
  let r = Math.random();
  let star = (r<0.05)? 5 : (r<0.25)? 4 : 3;
  alert("抽到 " + star + "★ 角色！");
}

/*-----------------------------------------------------------
  技能：地獄業火
-----------------------------------------------------------*/
function useSkill(){
  if(player.mp < 20){ alert("MP不足"); return; }
  player.mp -= 20;
  enemies.forEach(e=>{
    e.hp -= 20;
  });
}

/*-----------------------------------------------------------
  更新
-----------------------------------------------------------*/
let exp = 0;

function update(){

  // 玩家移動
  if(keys["w"]) player.y -= player.speed;
  if(keys["s"]) player.y += player.speed;
  if(keys["a"]) player.x -= player.speed;
  if(keys["d"]) player.x += player.speed;

  // MP 回復
  player.mp = Math.min(player.maxMP, player.mp + player.mpRegen);

  // 怪物 AI（靠近玩家）
  enemies.forEach((e,idx)=>{
    if(e.hp <= 0){
      exp += 10;
      gold += 5;
      enemies.splice(idx,1);
      return;
    }
    let dx = player.x - e.x;
    let dy = player.y - e.y;
    let dist = Math.hypot(dx,dy);
    if(dist>1){
      e.x += dx/dist * 0.5;
      e.y += dy/dist * 0.5;
    }
  });
}

/*-----------------------------------------------------------
  繪製
-----------------------------------------------------------*/
function render(){
  ctx.fillStyle = currentArea.color;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // 建築物
  if(currentArea.buildings){
    currentArea.buildings.forEach(b=>{
      ctx.fillStyle = b.color;
      ctx.fillRect(b.x,b.y,b.w,b.h);
      ctx.fillStyle = "#000";
      ctx.fillText(b.name,b.x+5,b.y+12);
    });
  }

  // NPC
  if(currentArea.npcs){
    currentArea.npcs.forEach(n=>{
      ctx.fillStyle = n.color;
      ctx.fillRect(n.x,n.y,n.w,n.h);
      ctx.fillStyle = "#fff";
      ctx.fillText(n.name,n.x-n.name.length*3,n.y-4);
    });
  }

  // 玩家
  ctx.fillStyle = "#fff";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  // 敵人
  enemies.forEach(e=>{
    ctx.fillStyle = e.color;
    ctx.fillRect(e.x,e.y,e.w,e.h);

    // 血條
    ctx.fillStyle = "red";
    ctx.fillRect(e.x, e.y-6, e.w, 3);
    ctx.fillStyle = "lime";
    ctx.fillRect(e.x, e.y-6, e.w*(e.hp/e.maxHP), 3);

    ctx.fillStyle = "#fff";
    ctx.fillText(e.name+" Lv."+e.lvl, e.x-10, e.y-10);
  });

  // UI 更新
  document.getElementById("hp").innerText = player.hp;
  document.getElementById("mp").innerText = Math.floor(player.mp);
  document.getElementById("gold").innerText = gold;
  document.getElementById("exp").innerText = exp;
}

/*-----------------------------------------------------------
  Loop
-----------------------------------------------------------*/
function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}
loop();

/*-----------------------------------------------------------
  Key listener
-----------------------------------------------------------*/
document.addEventListener("keydown", e=> keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e=> keys[e.key.toLowerCase()] = false);

</script>

</body>
</html>

