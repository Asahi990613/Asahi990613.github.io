<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG Final Complete</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px;font-size:14px}
#regionMenu{position:fixed;right:10px;top:10px;background:#111;padding:8px;border-radius:6px}
#dialogBox{
  position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
  background:rgba(0,0,0,.85);padding:12px;border-radius:8px;
  width:70%;display:none
}
button{cursor:pointer}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP <span id="hp"></span>　
MP <span id="mp"></span>　
ATK <span id="atk"></span><br>
G <span id="gold"></span>　
EXP <span id="exp"></span>　
LV <span id="lv"></span><br>
任務：<span id="questText">無</span>
</div>

<div id="regionMenu">
<b>區域</b><br>
<button onclick="changeArea('village')">村莊</button>
<button onclick="changeArea('forest')">森林</button>
<button onclick="changeArea('desert')">沙漠</button>
<button onclick="changeArea('swamp')">沼澤</button>
<button onclick="changeArea('dungeon')">地城</button>
</div>

<div id="dialogBox">
<div id="dialogText"></div>
<div style="text-align:right">
<button onclick="nextDialog()">下一步</button>
</div>
</div>

<script>
/* ================= 基本 ================= */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let keys={};

const player={
 x:460,y:260,w:20,h:20,
 hp:120,maxHp:120,
 mp:60,maxMp:60,mpRegen:0.15,
 atk:6,lv:1,exp:0,expNext:100,
 speed:2,isMember:false
};
let gold=50;

/* ================= 區域 ================= */
const AREAS={
 village:{
  key:'village',color:'#bda78a',
  buildings:[
   {x:120,y:200,w:140,h:80,type:'shop',name:'武器店',door:{x:180,y:260,w:40,h:18}},
   {x:340,y:180,w:180,h:100,type:'guild',name:'冒險者公會',door:{x:420,y:270,w:40,h:18}}
  ]
 },
 forest:{key:'forest',color:'#123a1a'},
 desert:{key:'desert',color:'#d8c98a'},
 swamp:{key:'swamp',color:'#234a2c'},
 dungeon:{key:'dungeon',color:'#2a2a2a'},

 shop_in:{
  key:'shop_in',color:'#3a2f24',
  counter:{x:260,y:160,w:200,h:30},
  door:{x:450,y:500,w:60,h:25},
  npcs:[
   {x:300,y:120,name:'武器店員',role:'shop'}
  ]
 },
 guild_in:{
  key:'guild_in',color:'#2f2f3a',
  counter:{x:260,y:160,w:200,h:30},
  door:{x:450,y:500,w:60,h:25},
  npcs:[
   {x:360,y:120,name:'公會接待',role:'guild'}
  ]
 }
};
let currentArea=AREAS.village;

/* ================= 怪物 ================= */
const MONS=[
 {name:'史萊姆',hp:20,atk:2,c:'#5af'},
 {name:'哥布林',hp:35,atk:4,c:'#6a4'},
 {name:'半獸人',hp:70,atk:8,c:'#a63'},
 {name:'蜥人',hp:50,atk:6,c:'#3a8'},
 {name:'鬼',hp:90,atk:10,c:'#aaa'}
];
const BOSS={name:'深淵鬼王',hp:400,atk:24,c:'#b22'};
let enemies=[];

function spawnEnemies(){
 enemies=[];
 if(currentArea.key.includes('in')||currentArea.key==='village')return;
 let n=currentArea.key==='dungeon'?7:5;
 for(let i=0;i<n;i++){
  let m=MONS[Math.floor(Math.random()*MONS.length)];
  enemies.push({
   x:Math.random()*860+40,y:Math.random()*420+40,
   w:22,h:22,hp:m.hp,maxHp:m.hp,atk:m.atk,
   name:m.name,c:m.c
  });
 }
 if(currentArea.key==='dungeon'){
  enemies.push({
   x:450,y:120,w:48,h:48,
   hp:BOSS.hp,maxHp:BOSS.hp,atk:BOSS.atk,
   name:BOSS.name,c:BOSS.c,boss:true
  });
 }
}

/* ================= 技能 ================= */
const SKILLS={
 1:{name:'地獄業火',mp:12,dmg:30},
 2:{name:'深海咒潮',mp:10,dmg:24},
 3:{name:'烈風斷章',mp:8,dmg:20},
 4:{name:'大地裁決',mp:14,dmg:36},
 5:{name:'聖焰審判',mp:20,dmg:60},
 6:{name:'破滅黯影',mp:18,dmg:55}
};
function castSkill(k){
 let s=SKILLS[k];
 if(!s||player.mp<s.mp)return;
 player.mp-=s.mp;
 enemies.forEach(e=>{
  let d=Math.hypot(e.x-player.x,e.y-player.y);
  if(d<160){e.hp-=s.dmg;if(e.hp<=0)killEnemy(e);}
 });
}

/* ================= 任務 ================= */
const QUESTS={
 E:{t:'史萊姆',c:3,r:30},
 D:{t:'哥布林',c:5,r:60},
 C:{t:'半獸人',c:5,r:120},
 B:{t:'蜥人',c:3,r:200},
 A:{t:'鬼',c:3,r:300},
 S:{t:'深淵鬼王',c:1,r:1000}
};
let quest=null,qCount=0;

/* ================= 對話 ================= */
let dialogQueue=[];
function showDialog(lines){
 dialogQueue=[...lines];
 dialogText.innerText=dialogQueue.shift();
 dialogBox.style.display='block';
}
function nextDialog(){
 if(dialogQueue.length===0){
  dialogBox.style.display='none';return;
 }
 dialogText.innerText=dialogQueue.shift();
}

/* ================= 擊殺 ================= */
function killEnemy(e){
 gold+=10;player.exp+=10;
 if(quest&&e.name===quest.t){
  qCount++;
  questText.innerText=`${quest.t} (${qCount}/${quest.c})`;
  if(qCount>=quest.c){
   showDialog([`任務完成！`,`這是報酬 ${quest.r} G`]);
   gold+=quest.r;quest=null;
   questText.innerText='無';
  }
 }
 enemies=enemies.filter(x=>x!==e);
}

/* ================= 互動 ================= */
function interact(){
 if(currentArea.key==='village'){
  currentArea.buildings.forEach(b=>{
   if(Math.hypot(player.x-b.door.x,player.y-b.door.y)<50){
    changeArea(b.type==='shop'?'shop_in':'guild_in');
   }
  });
 }
 if(currentArea.door &&
  Math.hypot(player.x-currentArea.door.x,player.y-currentArea.door.y)<60){
  changeArea('village');
 }
 if(currentArea.npcs){
  currentArea.npcs.forEach(n=>{
   if(Math.hypot(player.x-n.x,player.y-n.y)<50){
    if(n.role==='guild'){
     if(!player.isMember){
      player.isMember=true;
      showDialog(['你已成為會員','今天要接什麼任務呢？']);
     }else{
      let lines=['可接任務：'];
      for(let k in QUESTS)
       lines.push(`[${k}] 打倒 ${QUESTS[k].c} ${QUESTS[k].t}`);
      showDialog(lines);
     }
    }
   }
  });
 }
}

/* ================= 更新 ================= */
function update(){
 if(keys.w)player.y-=player.speed;
 if(keys.s)player.y+=player.speed;
 if(keys.a)player.x-=player.speed;
 if(keys.d)player.x+=player.speed;
 player.mp=Math.min(player.maxMp,player.mp+player.mpRegen);
 enemies.forEach(e=>{
  let dx=player.x-e.x,dy=player.y-e.y;
  let d=Math.hypot(dx,dy);
  if(d>1){e.x+=dx/d*0.3;e.y+=dy/d*0.3;}
 });
}

/* ================= 繪製 ================= */
function render(){
 ctx.fillStyle=currentArea.color;
 ctx.fillRect(0,0,960,540);

 if(currentArea.buildings){
  currentArea.buildings.forEach(b=>{
   ctx.fillStyle='#654';
   ctx.fillRect(b.x,b.y,b.w,b.h);
   ctx.fillStyle='#000';
   ctx.fillText(b.name,b.x+6,b.y+14);
   ctx.fillStyle='#000';
   ctx.fillRect(b.door.x,b.door.y,b.door.w,b.door.h);
  });
 }

 if(currentArea.counter){
  ctx.fillStyle='#222';
  ctx.fillRect(
   currentArea.counter.x,
   currentArea.counter.y,
   currentArea.counter.w,
   currentArea.counter.h
  );
 }

 if(currentArea.npcs){
  currentArea.npcs.forEach(n=>{
   ctx.fillStyle=n.role==='guild'?'#4af':'#fa4';
   ctx.fillRect(n.x,n.y,18,18);
   ctx.fillStyle='#fff';
   ctx.fillText(n.name,n.x+9,n.y-6);
  });
 }

 ctx.fillStyle='#fff';
 ctx.fillRect(player.x,player.y,player.w,player.h);

 enemies.forEach(e=>{
  ctx.fillStyle=e.c;
  ctx.fillRect(e.x,e.y,e.w,e.h);
  ctx.fillStyle='#000';
  ctx.fillRect(e.x,e.y-10,e.w,4);
  ctx.fillStyle='#f33';
  ctx.fillRect(e.x,e.y-10,e.w*(e.hp/e.maxHp),4);
  ctx.fillStyle='#fff';
  ctx.fillText(e.name,e.x+e.w/2,e.y-14);
 });

 hp.innerText=`${Math.floor(player.hp)}/${player.maxHp}`;
 mp.innerText=Math.floor(player.mp);
 atk.innerText=player.atk;
 gold.innerText=gold;
 exp.innerText=player.exp;
 lv.innerText=player.lv;
}

/* ================= 主迴圈 ================= */
function loop(){update();render();requestAnimationFrame(loop);}
function changeArea(k){currentArea=AREAS[k];spawnEnemies();}
requestAnimationFrame(loop);

/* ================= 輸入 ================= */
window.onkeydown=e=>{
 keys[e.key.toLowerCase()]=true;
 if(e.key>='1'&&e.key<='6')castSkill(e.key);
 if(e.key==='e')interact();
};
window.onkeyup=e=>keys[e.key.toLowerCase()]=false;
</script>
</body>
</html>
