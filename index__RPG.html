<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG - Final Complete</title>
<style>
body{margin:0;background:#070707;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px}
#menu{position:fixed;right:10px;top:10px;background:#111;padding:8px}
.panel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
background:#111;padding:12px;border-radius:8px;display:none}
button{cursor:pointer;margin:2px}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP:<span id="hp"></span>
MP:<span id="mp"></span>
ATK:<span id="atk"></span><br>
LV:<span id="lv"></span>
Gold:<span id="gold"></span><br>
Quest:<span id="questText">無</span>
</div>

<div id="menu">
<button onclick="changeArea('village')">村莊</button>
<button onclick="changeArea('forest')">森林</button>
<button onclick="changeArea('dungeon')">地城</button>
</div>

<div id="dialog" class="panel"></div>
<div id="shop" class="panel"></div>
<div id="guild" class="panel"></div>

<script>
// ================= 基本 =================
const c = document.getElementById("game");
const ctx = c.getContext("2d");
let keys={};

// ================= 玩家 =================
let player={
 x:460,y:280,w:20,h:28,
 hp:120,maxHp:120,
 mp:60,maxMp:60,
 atk:8,lv:1,exp:0,expNext:100,
 speed:2,isDead:false,
 weapon:"木劍"
};
let gold=50;

// ================= 存檔 =================
function save(){
 localStorage.setItem("rpgSave",JSON.stringify({player,gold}));
}
function load(){
 const s=localStorage.getItem("rpgSave");
 if(s){({player,gold}=JSON.parse(s));}
}
load();

// ================= 技能 =================
const SKILLS={
 1:{name:"火焰斬",mp:10,dmg:35,color:"orange"},
 2:{name:"雷霆擊",mp:15,dmg:55,color:"yellow"},
 3:{name:"聖光裁決",mp:20,dmg:80,color:"white"}
};
let effects=[];

// ================= 地圖 =================
const AREAS={
 village:{
  color:"#bda78a",
  buildings:[
   {x:60,y:150,w:200,h:160,type:"shop"},
   {x:340,y:120,w:260,h:200,type:"guild"}
  ],
  npcs:[
   {x:160,y:300,role:"shop",name:"武器商"},
   {x:460,y:330,role:"guild",name:"公會接待"}
  ]
 },
 forest:{color:"#103814"},
 dungeon:{color:"#2b2b2b"}
};
let area="village";

// ================= 任務 =================
const QUESTS={
 E:{desc:"擊倒3隻史萊姆",target:"史萊姆",count:3,reward:{gold:30,exp:30}},
 S:{desc:"擊敗地城Boss",target:"深淵鬼王",count:1,reward:{gold:300,exp:300}}
};
let quest=null,progress=0,done=false;

// ================= 敵人 =================
let enemies=[];
function spawnEnemies(){
 enemies=[];
 if(area==="forest"){
  for(let i=0;i<5;i++)enemies.push({x:Math.random()*800+50,y:100,
   w:22,h:22,name:"史萊姆",hp:20,maxHp:20,atk:2,c:"#5af"});
 }
 if(area==="dungeon"){
  enemies.push({x:450,y:140,w:48,h:48,name:"深淵鬼王",
   hp:300,maxHp:300,atk:15,c:"#b22",boss:true});
 }
}

// ================= 畫圖 =================
function drawBuildings(){
 AREAS.village.buildings.forEach(b=>{
  ctx.fillStyle=b.type==="shop"?"#8b5a2b":"#555";
  ctx.fillRect(b.x,b.y,b.w,b.h);
  ctx.fillStyle="#333";
  ctx.fillRect(b.x+20,b.y-30,b.w-40,30);
  ctx.fillStyle="#222";
  ctx.fillRect(b.x+b.w/2-15,b.y+b.h-40,30,40);
 });
}
function drawPlayer(){
 const x=player.x,y=player.y;
 ctx.fillStyle="#f2c9ac"; ctx.fillRect(x+6,y,8,8);
 ctx.fillStyle="#3a6ee8"; ctx.fillRect(x+4,y+8,12,10);
 ctx.fillStyle="#222";
 ctx.fillRect(x+4,y+18,4,8); ctx.fillRect(x+12,y+18,4,8);
 ctx.fillStyle="#aaa"; ctx.fillRect(x+16,y+10,12,2);
}

// ================= 戰鬥 =================
function attack(){
 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<40){
   e.hp-=player.atk;
   if(e.hp<=0)kill(e);
  }
 });
}
function cast(i){
 const s=SKILLS[i];
 if(!s||player.mp<s.mp)return;
 player.mp-=s.mp;
 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<140){
   e.hp-=s.dmg;
   if(e.hp<=0)kill(e);
  }
 });
 effects.push({x:player.x,y:player.y,c:s.color,t:0});
}
function kill(e){
 if(quest && e.name===quest.target && !done){
  progress++;
  if(progress>=quest.count){done=true;questText.innerText="任務完成";}
 }
 gold+=10;player.exp+=10;
 enemies=enemies.filter(x=>x!==e);
}

// ================= UI =================
function openShop(){
 shop.style.display="block";
 shop.innerHTML=`<h3>武器店</h3>
 木劍 ATK+0<br>
 鐵劍 ATK+5 <button onclick="buy()">購買</button><br>
 <button onclick="shop.style.display='none'">離開</button>`;
}
function buy(){
 if(gold<50)return;
 gold-=50;player.atk+=5;player.weapon="鐵劍";
 save();
}
function openGuild(){
 guild.style.display="block";
 let html="<h3>冒險者公會</h3>";
 if(!quest){
  html+=`<button onclick="accept()">接受任務</button>`;
 }
 if(done){
  html+=`<button onclick="reward()">領取報酬</button>`;
 }
 html+=`<br><button onclick="guild.style.display='none'">離開</button>`;
 guild.innerHTML=html;
}
function accept(){
 quest=QUESTS.E;progress=0;done=false;
 questText.innerText=quest.desc;
 guild.style.display="none";
}
function reward(){
 gold+=quest.reward.gold;
 player.exp+=quest.reward.exp;
 quest=null;done=false;
 questText.innerText="無";
 guild.style.display="none";
 save();
}

// ================= 更新 =================
function update(){
 if(player.isDead)return;
 if(keys.w)player.y-=player.speed;
 if(keys.s)player.y+=player.speed;
 if(keys.a)player.x-=player.speed;
 if(keys.d)player.x+=player.speed;

 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<24){
   player.hp-=e.atk*0.05;
  }
 });
 player.hp=Math.max(0,player.hp);
 if(player.hp<=0){
  player.isDead=true;
  alert("你死了，回村莊");
  changeArea("village");
  player.hp=player.maxHp;
  player.isDead=false;
 }
 effects.forEach(f=>f.t+=0.05);
 effects=effects.filter(f=>f.t<1);
}

// ================= 繪製 =================
function render(){
 ctx.fillStyle=AREAS[area].color;
 ctx.fillRect(0,0,c.width,c.height);
 if(area==="village")drawBuildings();
 drawPlayer();
 enemies.forEach(e=>{
  ctx.fillStyle=e.c;ctx.fillRect(e.x,e.y,e.w,e.h);
 });
 effects.forEach(f=>{
  ctx.globalAlpha=1-f.t;
  ctx.fillStyle=f.c;
  ctx.beginPath();
  ctx.arc(f.x+10,f.y+10,100*f.t,0,Math.PI*2);
  ctx.fill();
  ctx.globalAlpha=1;
 });

 hp.innerText=Math.round(player.hp)+"/"+player.maxHp;
 mp.innerText=Math.round(player.mp)+"/"+player.maxMp;
 atk.innerText=player.atk;
 lv.innerText=player.lv;
 gold.innerText=gold;
}

// ================= 互動 =================
function interact(){
 if(area!=="village")return;
 AREAS.village.npcs.forEach(n=>{
  if(Math.hypot(player.x-n.x,player.y-n.y)<40){
   if(n.role==="shop")openShop();
   if(n.role==="guild")openGuild();
  }
 });
}

// ================= 控制 =================
window.addEventListener("keydown",e=>{
 keys[e.key]=true;
 if(e.key===" ")attack();
 if(e.key>="1"&&e.key<="3")cast(Number(e.key));
 if(e.key==="e")interact();
});
window.addEventListener("keyup",e=>keys[e.key]=false);

// ================= 主迴圈 =================
function loop(){update();render();requestAnimationFrame(loop);}
changeArea("village");
function changeArea(a){area=a;spawnEnemies();}
loop();
</script>
</body>
</html>

