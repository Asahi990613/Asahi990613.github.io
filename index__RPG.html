<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>異世界 RPG</title>
<style>
  body { margin:0; background:#000; overflow:hidden; }
  canvas { display:block; margin:auto; background:#222; }
  #ui {
    position:fixed; top:10px; left:10px;
    color:white; font-family:monospace; font-size:14px;
  }
  #dialog {
    position:fixed; bottom:20px; left:50%;
    transform:translateX(-50%);
    width:500px; padding:10px;
    background:rgba(0,0,0,0.8);
    color:white; display:none;
    border:2px solid white;
  }
</style>
</head>
<body>

<canvas id="game" width="800" height="480"></canvas>
<div id="ui"></div>
<div id="dialog"></div>

<script>
/* ================= 基本設定 ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");
const dialog = document.getElementById("dialog");

const keys = {};
let currentArea = null;
let dialogOpen = false;

/* ================= 玩家 ================= */
const player = {
  x:400,y:240,w:16,h:16,
  speed:2,
  hp:100,maxHp:100,
  mp:50,maxMp:50,
  atk:10,
  level:1,exp:0,
  gold:50,
  weapon:null
};

/* ================= 區域 ================= */
const AREAS = {
  village:{
    key:"village", name:"村莊", color:"#4a7a4a",
    buildings:[
      {x:150,y:200,type:"guild"},
      {x:600,y:200,type:"shop"}
    ],
    npcs:[
      {x:400,y:120,name:"村民"}
    ]
  },
  forest:{
    key:"forest", name:"森林", color:"#2f5f2f",
    enemies:[]
  },
  guild_interior:{
    key:"guild_interior", name:"冒險者公會（內）",
    color:"#2f2f3a",
    counter:{x:300,y:150,w:200,h:30},
    exit:{x:360,y:380,w:80,h:40},
    npcs:[{x:400,y:120,name:"公會接待",role:"guild"}]
  },
  shop_interior:{
    key:"shop_interior", name:"武器店（內）",
    color:"#3a2f24",
    counter:{x:300,y:150,w:200,h:30},
    exit:{x:360,y:380,w:80,h:40},
    npcs:[{x:400,y:120,name:"店員",role:"shop"}]
  }
};

/* ================= 怪物 ================= */
function spawnSlime(){
  return {
    x:Math.random()*700+50,
    y:Math.random()*300+50,
    hp:30,maxHp:30,
    atk:5,
    name:"史萊姆",
    level:1
  };
}

/* ================= 任務 ================= */
let quest = null;

/* ================= 輸入 ================= */
window.onkeydown = e=>{
  keys[e.code]=true;
  if(e.code==="KeyE") interact();
  if(e.code==="Digit1") castSkill(1);
  if(e.code==="Digit2") castSkill(2);
  if(e.code==="Digit3") castSkill(3);
};
window.onkeyup = e=> keys[e.code]=false;

/* ================= 互動 ================= */
function interact(){
  if(dialogOpen) return;

  // 出入口
  if(currentArea.exit &&
     dist(player,currentArea.exit)<40){
    changeArea("village"); return;
  }

  // 建築
  if(currentArea.buildings){
    for(let b of currentArea.buildings){
      if(dist(player,b)<50){
        if(b.type==="guild") changeArea("guild_interior");
        if(b.type==="shop") changeArea("shop_interior");
        return;
      }
    }
  }

  // NPC
  if(currentArea.npcs){
    for(let n of currentArea.npcs){
      if(dist(player,n)<40){
        if(n.role==="guild") openGuild();
        else if(n.role==="shop") openShop();
        else showDialog(n.name+"：歡迎來到村莊！");
      }
    }
  }
}

/* ================= UI ================= */
function showDialog(text){
  dialogOpen=true;
  dialog.innerHTML=text+"<br><br><small>(按 E 關閉)</small>";
  dialog.style.display="block";
  window.onkeydown = e=>{
    if(e.code==="KeyE"){
      dialog.style.display="none";
      dialogOpen=false;
      window.location.reload();
    }
  };
}

function openGuild(){
  if(!quest){
    quest={target:3,kill:0};
    showDialog("公會：E級任務：擊敗 3 隻史萊姆");
  }else{
    showDialog("公會：任務進度 "+quest.kill+"/"+quest.target);
  }
}

function openShop(){
  if(player.gold>=30){
    player.gold-=30;
    player.atk+=5;
    showDialog("你購買了鐵劍，攻擊力提升！");
  }else{
    showDialog("金幣不足！");
  }
}

/* ================= 技能 ================= */
function castSkill(id){
  if(player.mp<10) return;
  player.mp-=10;
  for(let e of currentArea.enemies||[]){
    if(dist(player,e)<60){
      e.hp-=player.atk*2;
    }
  }
}

/* ================= 區域切換 ================= */
function changeArea(key){
  currentArea=AREAS[key];
  if(key==="forest"){
    currentArea.enemies=[spawnSlime()];
  }
  player.x=400; player.y=240;
}

/* ================= 工具 ================= */
function dist(a,b){
  return Math.hypot(a.x-b.x,a.y-b.y);
}

/* ================= 更新 ================= */
function update(){
  if(!dialogOpen){
    if(keys["KeyW"]) player.y-=player.speed;
    if(keys["KeyS"]) player.y+=player.speed;
    if(keys["KeyA"]) player.x-=player.speed;
    if(keys["KeyD"]) player.x+=player.speed;
  }

  if(currentArea.enemies){
    for(let e of currentArea.enemies){
      if(e.hp<=0){
        player.exp+=10; player.gold+=5;
        if(quest) quest.kill++;
        currentArea.enemies=[];
      }else{
        e.x+=(player.x-e.x)*0.002;
        e.y+=(player.y-e.y)*0.002;
      }
    }
  }

  player.mp=Math.min(player.maxMp,player.mp+0.05);
}

/* ================= 繪製 ================= */
function draw(){
  ctx.fillStyle=currentArea.color;
  ctx.fillRect(0,0,800,480);

  // 建築
  if(currentArea.buildings){
    for(let b of currentArea.buildings){
      ctx.fillStyle=b.type==="guild"?"#555":"#774";
      ctx.fillRect(b.x-30,b.y-30,60,60);
    }
  }

  // 櫃台
  if(currentArea.counter){
    ctx.fillStyle="#222";
    ctx.fillRect(
      currentArea.counter.x,
      currentArea.counter.y,
      currentArea.counter.w,
      currentArea.counter.h
    );
  }

  // 出口
  if(currentArea.exit){
    ctx.fillStyle="#666";
    ctx.fillRect(
      currentArea.exit.x,
      currentArea.exit.y,
      currentArea.exit.w,
      currentArea.exit.h
    );
  }

  // NPC
  if(currentArea.npcs){
    for(let n of currentArea.npcs){
      ctx.fillStyle="#ffd";
      ctx.fillRect(n.x-8,n.y-8,16,16);
    }
  }

  // 敵人
  if(currentArea.enemies){
    for(let e of currentArea.enemies){
      ctx.fillStyle="#0f0";
      ctx.fillRect(e.x-8,e.y-8,16,16);
    }
  }

  // 玩家
  ctx.fillStyle="#0af";
  ctx.fillRect(player.x-8,player.y-8,16,16);

  ui.innerHTML=
    `HP ${player.hp}/${player.maxHp}<br>`+
    `MP ${Math.floor(player.mp)}/${player.maxMp}<br>`+
    `金幣 ${player.gold}<br>`+
    `地區 ${currentArea.name}`;
}

/* ================= 主迴圈 ================= */
function loop(){
  update(); draw();
  requestAnimationFrame(loop);
}

changeArea("village");
loop();
</script>
</body>
</html>
