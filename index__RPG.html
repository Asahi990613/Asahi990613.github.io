<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG Project</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#111;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px;font-size:14px}
#mapUI{
 position:fixed;right:10px;top:10px;
 background:#111;padding:8px;border-radius:6px
}
#help{
 position:fixed;left:10px;bottom:10px;
 background:rgba(0,0,0,0.6);
 padding:8px;border-radius:6px;
 font-size:13px
}
button{margin:2px}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP:<span id="hp"></span>
MP:<span id="mp"></span>
Gold:<span id="gold"></span>
</div>

<div id="mapUI">
<b>地區</b><br>
<button onclick="changeScene('village')">村莊</button>
<button onclick="changeScene('forest')">森林</button>
</div>

<div id="help">
WASD：移動<br>
E：互動 / 進門<br>
Space：普攻<br>
1~3：技能<br>
Z：包包
</div>

<script>
/* ========= 基本 ========= */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let keys={};
let scene="village";

/* ========= 玩家 ========= */
const player={
 x:460,y:320,w:20,h:28,
 hp:100,maxHp:100,
 mp:50,maxMp:50,
 atk:6,def:0,speed:2
};
let gold=30;

/* ========= 建築（村莊） ========= */
const buildings={
 guild:{x:300,y:180,w:180,h:140,name:"冒險者公會"},
 shop:{x:520,y:200,w:160,h:120,name:"商店"}
};

/* ========= 地區切換 ========= */
function changeScene(s){
 scene=s;
 if(scene==="village"){
  player.x=460;player.y=320;
 }
 if(scene==="forest"){
  player.x=120;player.y=260;
 }
}

/* ========= 更新 ========= */
function update(){
 if(keys.w)player.y-=player.speed;
 if(keys.s)player.y+=player.speed;
 if(keys.a)player.x-=player.speed;
 if(keys.d)player.x+=player.speed;

 player.x=Math.max(0,Math.min(canvas.width-player.w,player.x));
 player.y=Math.max(0,Math.min(canvas.height-player.h,player.y));
}

/* ========= 繪製 ========= */
function drawPlayer(){
 ctx.fillStyle="#f2c9ac";
 ctx.fillRect(player.x+6,player.y,8,8);
 ctx.fillStyle="#3a6ee8";
 ctx.fillRect(player.x+4,player.y+8,12,10);
 ctx.fillStyle="#222";
 ctx.fillRect(player.x+4,player.y+18,4,8);
 ctx.fillRect(player.x+12,player.y+18,4,8);
}

function drawBuilding(b){
 ctx.fillStyle="#6b4";
 ctx.fillRect(b.x,b.y,b.w,b.h);
 ctx.fillStyle="#000";
 ctx.fillRect(b.x+b.w/2-12,b.y+b.h-24,24,24); // 門
 ctx.fillStyle="#fff";
 ctx.fillText(b.name,b.x+10,b.y+18);
}

function render(){
 /* 背景 */
 ctx.fillStyle = scene==="village" ? "#bda78a" : "#103814";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 /* 建築只在村莊 */
 if(scene==="village"){
  drawBuilding(buildings.guild);
  drawBuilding(buildings.shop);
 }

 drawPlayer();

 hp.innerText=Math.round(player.hp);
 mp.innerText=Math.round(player.mp);
 gold.innerText=gold;
}

/* ========= 互動 ========= */
function interact(){
 if(scene!=="village")return;

 for(const k in buildings){
  const b=buildings[k];
  const d=Math.hypot(
   player.x-(b.x+b.w/2),
   player.y-(b.y+b.h)
  );
  if(d<40){
   alert(b.name+"（第 2 段會進入室內）");
  }
 }
}

/* ========= 控制 ========= */
window.addEventListener("keydown",e=>{
 keys[e.key.toLowerCase()]=true;
 if(e.key.toLowerCase()==="e")interact();
});
window.addEventListener("keyup",e=>{
 keys[e.key.toLowerCase()]=false;
});

/* ========= 主迴圈 ========= */
(function loop(){
 update();
 render();
 requestAnimationFrame(loop);
})();
/* =========================================================
   第 2 段：室內場景 / 任務 / 商店 / 戰鬥 / 包包裝備
   ========================================================= */

/* ===== 新場景 ===== */
let subScene = null; // null / guild / shop

/* ===== 任務 ===== */
const quests = [
 {id:1,name:"清除史萊姆",target:"史萊姆",need:3,progress:0,reward:30},
 {id:2,name:"擊退哥布林",target:"哥布林",need:3,progress:0,reward:50}
];
let activeQuest = null;

/* ===== 森林怪物 ===== */
let enemies = [];
function spawnForestEnemies(){
 enemies=[
  {name:"史萊姆",lv:1,x:400,y:300,hp:30,maxHp:30,atk:2},
  {name:"史萊姆",lv:1,x:500,y:260,hp:30,maxHp:30,atk:2},
  {name:"哥布林",lv:2,x:600,y:340,hp:45,maxHp:45,atk:4}
 ];
}

/* ===== 包包 / 裝備 ===== */
const inventory=[];
const equipment={weapon:null,armor:null,boots:null};
const items={
 sword:{name:"鐵劍",atk:5,type:"weapon"},
 armor:{name:"皮甲",def:3,type:"armor"},
 boots:{name:"皮靴",speed:1,type:"boots"}
};

/* ===== 改寫場景切換 ===== */
const _changeScene = changeScene;
changeScene = function(s){
 _changeScene(s);
 subScene = null;
 if(s==="forest") spawnForestEnemies();
};

/* ===== 改寫互動 ===== */
const _interact = interact;
interact = function(){
 if(scene==="village"){
  for(const k in buildings){
   const b=buildings[k];
   const d=Math.hypot(
    player.x-(b.x+b.w/2),
    player.y-(b.y+b.h)
   );
   if(d<40){
    subScene = (k==="guild") ? "guild" : "shop";
    return;
   }
  }
 }
 else if(scene==="forest"){
  return;
 }
};

/* ===== 戰鬥 ===== */
function attack(){
 if(scene!=="forest")return;
 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<60){
   e.hp-=player.atk;
   if(activeQuest && e.name===activeQuest.target){
    activeQuest.progress++;
   }
   if(e.hp<=0){
    gold+=10;
   }
  }
 });
 enemies=enemies.filter(e=>e.hp>0);
 if(activeQuest && activeQuest.progress>=activeQuest.need){
  alert("任務完成！回公會領獎");
 }
}

/* ===== 技能 ===== */
function castSkill(i){
 if(scene!=="forest")return;
 const cost=[0,5,8,12][i];
 if(player.mp<cost)return;
 player.mp-=cost;
 attack();
}

/* ===== 商店購買 ===== */
function buyItem(id,price){
 if(gold<price)return;
 gold-=price;
 inventory.push({...items[id]});
}

/* ===== 裝備 ===== */
function equipItem(i){
 const it=inventory[i];
 equipment[it.type]=it;
 player.atk=6+(equipment.weapon?.atk||0);
 player.def=(equipment.armor?.def||0);
 player.speed=2+(equipment.boots?.speed||0);
}

/* ===== 繪製補充 ===== */
const _render = render;
render = function(){
 _render();

 /* ===== 森林怪物 ===== */
 if(scene==="forest"){
  enemies.forEach(e=>{
   ctx.fillStyle="#6a4";
   ctx.fillRect(e.x,e.y,22,22);
   ctx.fillStyle="#f33";
   ctx.fillRect(e.x,e.y-6,22*(e.hp/e.maxHp),4);
   ctx.fillStyle="#fff";
   ctx.fillText(`${e.name} Lv${e.lv}`,e.x-10,e.y-10);
  });
 }

 /* ===== 公會室內 ===== */
 if(subScene==="guild"){
  ctx.fillStyle="#2b2b3a";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#555";
  ctx.fillRect(300,180,360,40);
  ctx.fillStyle="#ffd";
  ctx.fillRect(470,150,20,20);
  ctx.fillStyle="#fff";
  ctx.fillText("公會櫃檯",430,140);

  if(!activeQuest){
   ctx.fillText("E：接任務",410,260);
  }else{
   ctx.fillText(
    `${activeQuest.name} ${activeQuest.progress}/${activeQuest.need}`,
    350,260
   );
   if(activeQuest.progress>=activeQuest.need){
    ctx.fillText("E：領取報酬",410,290);
   }
  }
  ctx.fillText("往下走離開",410,480);
 }

 /* ===== 商店室內 ===== */
 if(subScene==="shop"){
  ctx.fillStyle="#3a2b2b";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ffd";
  ctx.fillRect(350,200,20,20);
  ctx.fillRect(550,200,20,20);
  ctx.fillStyle="#fff";
  ctx.fillText("藥水商人",310,190);
  ctx.fillText("武器商人",510,190);
  ctx.fillText("E：購買鐵劍(30G)",470,260);
  ctx.fillText("往下走離開",410,480);
 }
};

/* ===== 室內互動 ===== */
window.addEventListener("keydown",e=>{
 if(e.key.toLowerCase()!=="e")return;

 if(subScene==="guild"){
  if(!activeQuest){
   activeQuest={...quests[0]};
  }else if(activeQuest.progress>=activeQuest.need){
   gold+=activeQuest.reward;
   activeQuest=null;
  }
 }
 else if(subScene==="shop"){
  buyItem("sword",30);
 }
});

/* ===== 包包 ===== */
window.addEventListener("keydown",e=>{
 if(e.key.toLowerCase()!=="z")return;
 let text="包包：\n";
 inventory.forEach((it,i)=>{
  text+=`${i+1}. ${it.name}\n`;
 });
 const idx=prompt(text+"輸入編號裝備");
 if(idx){
  equipItem(idx-1);
 }
});

/* ===== 攻擊 / 技能 ===== */
window.addEventListener("keydown",e=>{
 if(e.key===" ")attack();
 if(e.key>="1"&&e.key<="3")castSkill(Number(e.key));
}); 
</script>
</body>
</html>


