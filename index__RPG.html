<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG - Complete</title>
<style>
body{margin:0;background:#070707;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px}
#regionMenu{position:fixed;right:10px;top:10px;background:#111;padding:8px;border-radius:6px}
#dialogBox{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;
background:rgba(0,0,0,.9);padding:12px;border-radius:8px;display:none;width:70%}
#shopUI,#questUI{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
background:#111;padding:12px;border-radius:8px;display:none}
button{cursor:pointer;margin:2px}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP:<span id="hp"></span>
MP:<span id="mp"></span>
ATK:<span id="atk"></span><br>
金幣:<span id="gold"></span>
EXP:<span id="exp"></span>
LV:<span id="lv"></span><br>
任務:<span id="questText">無</span>
</div>

<div id="regionMenu">
<b>區域</b><br>
<button onclick="changeArea('village')">村莊</button>
<button onclick="changeArea('forest')">森林</button>
<button onclick="changeArea('dungeon')">地城</button>
</div>

<div id="dialogBox">
<div id="dialogText"></div>
<div style="text-align:right"><button onclick="nextDialog()">下一步</button></div>
</div>

<div id="shopUI"></div>
<div id="questUI"></div>

<script>
// ===== Canvas =====
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let keys = {};

// ===== Player =====
const player = {
  x: 480, y: 270, w: 20, h: 28,
  hp: 120, maxHp: 120,
  mp: 60, maxMp: 60,
  atk: 6, lv: 1,
  exp: 0, expNext: 100,
  speed: 2,
  crit: 0.15,
  dir: 'down',
  frame: 0,
  isMember: false
};
let gold = 30;

// ===== Areas =====
const AREAS = {
  village:{color:'#bda78a',npcs:[
    {x:200,y:260,role:'shop',name:'店員'},
    {x:360,y:260,role:'guild',name:'公會接待'}
  ]},
  forest:{color:'#103814'},
  dungeon:{color:'#2b2b2b'}
};
let currentArea = 'village';

// ===== Enemies =====
const MONS = [
  {name:'史萊姆',hp:20,atk:2,c:'#5af'},
  {name:'哥布林',hp:35,atk:4,c:'#6a4'}
];
const BOSS = {name:'深淵鬼王',hp:300,atk:18,c:'#b22'};
let enemies = [];

// ===== Quests =====
const QUESTS = {
  E:{rank:'E',desc:'擊倒3隻史萊姆',target:'史萊姆',count:3},
  S:{rank:'S',desc:'擊敗地城Boss',target:'深淵鬼王',count:1}
};
const REWARD = {
  E:{exp:30,gold:30},
  S:{exp:300,gold:300}
};
let currentQuest=null,questProgress=0,questDone=false;

// ===== Spawn =====
function spawnEnemies(){
  enemies=[];
  if(currentArea==='village') return;
  for(let i=0;i<5;i++){
    const m=MONS[Math.floor(Math.random()*MONS.length)];
    enemies.push({
      x:Math.random()*800+50,
      y:Math.random()*400+80,
      w:22,h:22,
      name:m.name,hp:m.hp,maxHp:m.hp,atk:m.atk,c:m.c
    });
  }
  if(currentArea==='dungeon'){
    enemies.push({
      x:450,y:120,w:48,h:48,
      name:BOSS.name,hp:BOSS.hp,maxHp:BOSS.hp,atk:BOSS.atk,c:BOSS.c,boss:true,phase:1
    });
  }
}

// ===== Combat =====
function attack(){
  enemies.forEach(e=>{
    const d=Math.hypot(player.x-e.x,player.y-e.y);
    if(d<40){
      let dmg=player.atk;
      if(Math.random()<player.crit) dmg*=2;
      e.hp-=dmg;
      if(e.hp<=0) killEnemy(e);
    }
  });
}

// ===== Enemy Death =====
function killEnemy(e){
  gold+=10;
  player.exp+=10;
  if(currentQuest && !questDone && e.name.includes(currentQuest.target)){
    questProgress++;
    if(questProgress>=currentQuest.count){
      questDone=true;
      document.getElementById('questText').innerText='任務已完成';
      showDialog(['任務已完成','回公會領取報酬']);
    }
  }
  enemies=enemies.filter(x=>x!==e);
}

// ===== Guild =====
function openGuild(){
  let html='<h3>冒險者公會</h3>';
  if(!player.isMember){
    html+='<button onclick="player.isMember=true;openGuild()">註冊會員</button>';
  }else{
    if(currentQuest && questDone){
      html+='<button onclick="claimReward()">領取任務報酬</button><hr>';
    }
    for(let k in QUESTS){
      html+=QUESTS[k].desc+' <button onclick="acceptQuest(\''+k+'\')">接受</button><br>';
    }
  }
  html+='<br><button onclick="closeQuest()">關閉</button>';
  questUI.innerHTML=html;
  questUI.style.display='block';
}
function acceptQuest(k){
  currentQuest=QUESTS[k];
  questProgress=0;questDone=false;
  questText.innerText=currentQuest.desc;
  closeQuest();
}
function claimReward(){
  const r=REWARD[currentQuest.rank];
  player.exp+=r.exp;gold+=r.gold;
  currentQuest=null;questDone=false;
  questText.innerText='無';
  closeQuest();
}
function closeQuest(){questUI.style.display='none';}

// ===== Draw Player =====
function drawPlayer(){
  const x=player.x,y=player.y;
  ctx.fillStyle='#f2c9ac'; ctx.fillRect(x+6,y,8,8);
  ctx.fillStyle='#3a6ee8'; ctx.fillRect(x+5,y+8,10,10);
  ctx.fillStyle='#222';
  ctx.fillRect(x+5,y+18,4,8);
  ctx.fillRect(x+11,y+18,4,8);
}

// ===== Update =====
function update(){
  let moving=false;
  if(keys.w){player.y-=player.speed;player.dir='up';moving=true;}
  if(keys.s){player.y+=player.speed;player.dir='down';moving=true;}
  if(keys.a){player.x-=player.speed;player.dir='left';moving=true;}
  if(keys.d){player.x+=player.speed;player.dir='right';moving=true;}

  enemies.forEach(e=>{
    const dx=player.x-e.x,dy=player.y-e.y;
    const d=Math.hypot(dx,dy);
    if(d>1){e.x+=dx/d*0.4;e.y+=dy/d*0.4;}
    if(d<24) player.hp-=e.atk*0.02;
  });

  if(player.exp>=player.expNext){
    player.exp-=player.expNext;
    player.lv++;
    player.expNext=Math.floor(player.expNext*1.6);
    player.maxHp+=10;player.hp=player.maxHp;
    player.atk+=2;
  }
}

// ===== Render =====
function render(){
  ctx.fillStyle=AREAS[currentArea].color;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(AREAS[currentArea].npcs){
    AREAS[currentArea].npcs.forEach(n=>{
      ctx.fillStyle='#fff';
      ctx.fillRect(n.x,n.y,12,16);
      ctx.fillText(n.name,n.x-6,n.y-6);
    });
  }

  drawPlayer();

  enemies.forEach(e=>{
    ctx.fillStyle=e.c;
    ctx.fillRect(e.x,e.y,e.w,e.h);
    ctx.fillStyle='#f33';
    ctx.fillRect(e.x,e.y-6,e.w*(e.hp/e.maxHp),4);
  });

  hp.innerText=Math.round(player.hp)+'/'+player.maxHp;
  mp.innerText=Math.round(player.mp)+'/'+player.maxMp;
  atk.innerText=player.atk;
  gold.innerText=gold;
  exp.innerText=player.exp;
  lv.innerText=player.lv;
}

// ===== Loop =====
function loop(){update();render();requestAnimationFrame(loop);}

// ===== Input =====
window.addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(e.key===' ') attack();
  if(e.key==='e'){
    if(currentArea==='village') openGuild();
  }
});
window.addEventListener('keyup',e=>keys[e.key]=false);

// ===== Dialog =====
let dialogQueue=[];
function showDialog(lines){
  dialogQueue=[...lines];
  dialogText.innerText=dialogQueue.shift();
  dialogBox.style.display='block';
}
function nextDialog(){
  if(dialogQueue.length===0){dialogBox.style.display='none';return;}
  dialogText.innerText=dialogQueue.shift();
}

// ===== Start =====
changeArea('village');
function changeArea(a){currentArea=a;spawnEnemies();}
loop();
</script>
</body>
</html>

