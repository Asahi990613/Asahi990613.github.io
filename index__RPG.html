<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG - Ultimate Full Version</title>
<style>
body{margin:0;background:#070707;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px;font-size:14px}
#regionMenu{position:fixed;right:10px;top:10px;background:#111;padding:8px;border-radius:6px}
#dialogBox{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;
background:rgba(0,0,0,.9);padding:12px;border-radius:8px;display:none;width:70%}
#shopUI,#questUI{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
background:#111;padding:12px;border-radius:8px;display:none;max-width:420px}
button{cursor:pointer;margin:2px}
#mobile{position:fixed;bottom:20px;left:20px}
#mobile button{width:48px;height:48px;font-size:18px}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP:<span id="hp"></span>
MP:<span id="mp"></span>
ATK:<span id="atk"></span><br>
é‡‘å¹£:<span id="gold"></span>
EXP:<span id="exp"></span>
LV:<span id="lv"></span><br>
ä»»å‹™:<span id="questText">ç„¡</span>
</div>

<div id="regionMenu">
<b>å€åŸŸ</b><br>
<button onclick="changeArea('village')">æ‘èŠ</button>
<button onclick="changeArea('forest')">æ£®æ—</button>
<button onclick="changeArea('desert')">æ²™æ¼ </button>
<button onclick="changeArea('swamp')">æ²¼æ¾¤</button>
<button onclick="changeArea('dungeon')">åœ°åŸ</button>
</div>

<div id="dialogBox">
<div id="dialogText"></div>
<div style="text-align:right"><button onclick="nextDialog()">ä¸‹ä¸€æ­¥</button></div>
</div>

<div id="shopUI"></div>
<div id="questUI"></div>

<div id="mobile">
<button ontouchstart="keys.w=true">â–²</button><br>
<button ontouchstart="keys.a=true">â—€</button>
<button ontouchstart="attack()">âš”</button>
<button ontouchstart="keys.d=true">â–¶</button><br>
<button ontouchstart="keys.s=true">â–¼</button>
</div>

<script>
// ================= åŸºæœ¬ =================
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
let keys={};

// ================= ç©å®¶ =================
const player={
x:480,y:270,w:20,h:20,
hp:120,maxHp:120,
mp:60,maxMp:60,
atk:6,lv:1,
exp:0,expNext:100,
crit:0.15,
speed:2,
isMember:false
};
let gold=30;

// ================= åœ°å€ =================
const AREAS={
village:{key:'village',name:'æ‘èŠ',color:'#bda78a',
buildings:[{x:140,y:200,w:110,h:70,c:'#6b3',name:'æ­¦å™¨åº—',type:'shop'},
{x:320,y:180,w:140,h:90,c:'#666',name:'å†’éšªè€…å…¬æœƒ',type:'guild'}],
npcs:[{x:170,y:250,name:'åº—å“¡',role:'shop'},
{x:360,y:250,name:'å…¬æœƒæ¥å¾…',role:'guild'}]},
forest:{key:'forest',color:'#103814'},
desert:{key:'desert',color:'#d7c584'},
swamp:{key:'swamp',color:'#24452b'},
dungeon:{key:'dungeon',color:'#2b2b2b'}
};
let currentArea=AREAS.village;

// ================= æ€ªç‰© =================
const MONS=[
{name:'å²èŠå§†',hp:20,atk:2,c:'#5af'},
{name:'å“¥å¸ƒæ—',hp:35,atk:4,c:'#6a4'},
{name:'åŠç¸äºº',hp:70,atk:8,c:'#a63'},
{name:'èœ¥äºº',hp:50,atk:6,c:'#3a8'},
{name:'é¬¼',hp:90,atk:10,c:'#aaa'}
];
const BOSS={name:'æ·±æ·µé¬¼ç‹',hp:400,atk:24,c:'#b22'};
let enemies=[];

// ================= ä»»å‹™ =================
const QUESTS={
E:{rank:'E',desc:'æ“Šå€’3éš»å²èŠå§†',target:'å²èŠå§†',count:3},
D:{rank:'D',desc:'æ¶ˆæ»…5éš»å“¥å¸ƒæ—',target:'å“¥å¸ƒæ—',count:5},
C:{rank:'C',desc:'è¨ä¼5éš»åŠç¸äºº',target:'åŠç¸äºº',count:5},
B:{rank:'B',desc:'æ“Šæ•—3éš»èœ¥äºº',target:'èœ¥äºº',count:3},
A:{rank:'A',desc:'æ·¨åŒ–3éš»é¬¼',target:'é¬¼',count:3},
S:{rank:'S',desc:'æ“Šæ•—åœ°åŸBoss',target:'æ·±æ·µé¬¼ç‹',count:1}
};
const REWARD={
E:{exp:30,gold:30},
D:{exp:70,gold:70},
C:{exp:150,gold:150},
B:{exp:260,gold:260},
A:{exp:400,gold:450},
S:{exp:1200,gold:1200}
};
let currentQuest=null,questProgress=0,questDone=false;

// ================= å­˜æª” =================
function save(){
localStorage.setItem('pixelRPG',JSON.stringify({player,gold,currentQuest,questProgress,questDone}));
}
function load(){
const d=localStorage.getItem('pixelRPG');
if(!d)return;
const s=JSON.parse(d);
Object.assign(player,s.player);
gold=s.gold;
currentQuest=s.currentQuest;
questProgress=s.questProgress;
questDone=s.questDone;
}

// ================= åŠŸèƒ½ =================
function spawnEnemies(){
enemies=[];
if(currentArea.key==='village')return;
let n=currentArea.key==='dungeon'?7:
let n = currentArea.key === 'dungeon' ? 8 : 6;
for(let i=0;i<n;i++){
  const m = MONS[Math.floor(Math.random()*MONS.length)];
  enemies.push({
    x:Math.random()*(canvas.width-60)+30,
    y:Math.random()*(canvas.height-100)+50,
    w:22,h:22,
    name:m.name,
    hp:m.hp,
    maxHp:m.hp,
    atk:m.atk,
    c:m.c,
    phase:1
  });
}
if(currentArea.key==='dungeon'){
  enemies.push({
    x:canvas.width/2-24,
    y:120,
    w:48,h:48,
    name:BOSS.name,
    hp:BOSS.hp,
    maxHp:BOSS.hp,
    atk:BOSS.atk,
    c:BOSS.c,
    boss:true,
    phase:1
  });
}
}

// ================= æ™®æ”» / æš´æ“Š =================
function attack(){
  enemies.forEach(e=>{
    const d=Math.hypot(player.x-e.x,player.y-e.y);
    if(d<40){
      let dmg=player.atk;
      if(Math.random()<player.crit){
        dmg*=2;
        showDialog(['æš´æ“Šï¼']);
      }
      e.hp-=dmg;
      if(e.hp<=0) onEnemyDefeated(e);
    }
  });
}

// ================= æŠ€èƒ½ =================
const SKILLS={
1:{mp:10,dmg:30},
2:{mp:15,dmg:45},
3:{mp:20,dmg:70}
};
function castSkill(i){
  const s=SKILLS[i];
  if(!s||player.mp<s.mp)return;
  player.mp-=s.mp;
  enemies.forEach(e=>{
    const d=Math.hypot(player.x-e.x,player.y-e.y);
    if(d<160){
      e.hp-=s.dmg;
      if(e.hp<=0) onEnemyDefeated(e);
    }
  });
}

// ================= Boss å¤šéšæ®µ =================
function bossAI(e){
  if(!e.boss)return;
  if(e.hp<e.maxHp*0.5 && e.phase===1){
    e.phase=2;
    e.atk*=1.5;
    showDialog(['Boss é€²å…¥ç¬¬äºŒéšæ®µï¼']);
  }
  if(e.hp<e.maxHp*0.25 && e.phase===2){
    e.phase=3;
    e.atk*=1.5;
    showDialog(['Boss ç‹‚æš´åŒ–ï¼']);
  }
}

// ================= æ•µäººæ­»äº¡ =================
function onEnemyDefeated(e){
  gold+=Math.floor(Math.random()*8)+5;
  player.exp+=Math.floor(Math.random()*10)+8;

  if(currentQuest && !questDone && e.name.includes(currentQuest.target)){
    questProgress++;
    if(questProgress>=currentQuest.count){
      questDone=true;
      document.getElementById('questText').innerText='ä»»å‹™å·²å®Œæˆ';
      showDialog(['âœ… ä»»å‹™å·²å®Œæˆ','å›åˆ°å†’éšªè€…å…¬æœƒé ˜å–å ±é…¬']);
    }
  }
  enemies=enemies.filter(x=>x!==e);
  save();
}
// ================= å…¬æœƒ / ä»»å‹™ =================
function openGuildUI(){
  let html = '<h3>å†’éšªè€…å…¬æœƒ</h3>';

  if(!player.isMember){
    html += 'å°šæœªè¨»å†Šå…¬æœƒ<br><button onclick="registerGuild()">è¨»å†Šæœƒå“¡</button>';
  }else{
    if(currentQuest && questDone){
      html += '<button onclick="claimReward()">ğŸ é ˜å–ä»»å‹™å ±é…¬</button><hr>';
    }
    for(let k in QUESTS){
      html += `[${k}] ${QUESTS[k].desc} 
      <button onclick="acceptQuest('${k}')">æ¥å—</button><br>`;
    }
  }
  html += '<br><button onclick="closeQuestUI()">é—œé–‰</button>';
  document.getElementById('questUI').innerHTML = html;
  document.getElementById('questUI').style.display = 'block';
}

function closeQuestUI(){
  document.getElementById('questUI').style.display = 'none';
}

function registerGuild(){
  player.isMember = true;
  showDialog(['ä½ å·²æˆç‚ºå†’éšªè€…å…¬æœƒæœƒå“¡']);
  save();
  openGuildUI();
}

function acceptQuest(k){
  currentQuest = QUESTS[k];
  questProgress = 0;
  questDone = false;
  document.getElementById('questText').innerText = currentQuest.desc;
  closeQuestUI();
  showDialog(['å·²æ¥å—ä»»å‹™', currentQuest.desc]);
  save();
}

function claimReward(){
  if(!currentQuest || !questDone) return;
  const r = REWARD[currentQuest.rank];
  player.exp += r.exp;
  gold += r.gold;
  showDialog([
    'ğŸ‰ ä»»å‹™å®Œæˆï¼',
    `ç²å¾— EXP ${r.exp}`,
    `ç²å¾— é‡‘å¹£ ${r.gold}`
  ]);
  currentQuest = null;
  questProgress = 0;
  questDone = false;
  document.getElementById('questText').innerText = 'ç„¡';
  save();
  closeQuestUI();
}
// ================= äº’å‹• =================
function interact(){
  if(!currentArea.npcs) return;
  for(const n of currentArea.npcs){
    const d = Math.hypot(player.x - n.x, player.y - n.y);
    if(d < 40){
      if(n.role === 'shop'){ openShopUI(); return; }
      if(n.role === 'guild'){ openGuildUI(); return; }
    }
  }
}

// ================= å•†åº— =================
const SHOP = [
  {name:'æœ¨åŠ',atk:2,price:20},
  {name:'éµåŠ',atk:8,price:120},
  {name:'å‹‡è€…ä¹‹åŠ',atk:25,price:500}
];

function openShopUI(){
  let html = '<h3>æ­¦å™¨åº—</h3>';
  SHOP.forEach(i=>{
    html += `${i.name} ATK+${i.atk} (${i.price}G)
    <button onclick="buy('${i.name}')">è³¼è²·</button><br>`;
  });
  html += '<br><button onclick="closeShopUI()">é—œé–‰</button>';
  document.getElementById('shopUI').innerHTML = html;
  document.getElementById('shopUI').style.display = 'block';
}

function closeShopUI(){
  document.getElementById('shopUI').style.display = 'none';
}

function buy(name){
  const it = SHOP.find(i=>i.name===name);
  if(!it || gold < it.price) return;
  gold -= it.price;
  player.atk = it.atk;
  showDialog([`è³¼è²·æˆåŠŸï¼š${it.name}`]);
  save();
  closeShopUI();
}

// ================= å€åŸŸåˆ‡æ› =================
function changeArea(k){
  currentArea = AREAS[k];
  spawnEnemies();
}

// ================= Update =================
function update(){
  if(keys.w) player.y -= player.speed;
  if(keys.s) player.y += player.speed;
  if(keys.a) player.x -= player.speed;
  if(keys.d) player.x += player.speed;

  player.x = Math.max(0,Math.min(canvas.width-player.w,player.x));
  player.y = Math.max(0,Math.min(canvas.height-player.h,player.y));

  player.mp = Math.min(player.maxMp, player.mp + 0.05);

  enemies.forEach(e=>{
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const dist = Math.hypot(dx,dy);
    if(dist>1){
      e.x += dx/dist*0.4;
      e.y += dy/dist*0.4;
    }
    if(dist<24){
      player.hp -= e.atk*0.02;
      if(player.hp<0) player.hp=0;
    }
    bossAI(e);
  });

  if(player.exp >= player.expNext){
    player.exp -= player.expNext;
    player.lv++;
    player.expNext = Math.floor(player.expNext * 1.6);
    player.maxHp += 12;
    player.hp = player.maxHp;
    player.atk += 2;
  }
}

// ================= Render =================
function render(){
  ctx.fillStyle = currentArea.color;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(currentArea.buildings){
    currentArea.buildings.forEach(b=>{
      ctx.fillStyle=b.c;
      ctx.fillRect(b.x,b.y,b.w,b.h);
      ctx.fillStyle='#000';
      ctx.fillText(b.name,b.x+6,b.y+14);
    });
  }

  if(currentArea.npcs){
    currentArea.npcs.forEach(n=>{
      ctx.fillStyle='#fff';
      ctx.fillRect(n.x,n.y,12,16);
      ctx.fillText(n.name,n.x-6,n.y-6);
    });
  }

  ctx.fillStyle='#fff';
  ctx.fillRect(player.x,player.y,player.w,player.h);

  enemies.forEach(e=>{
    ctx.fillStyle=e.c;
    ctx.fillRect(e.x,e.y,e.w,e.h);
    ctx.fillStyle='#f33';
    ctx.fillRect(e.x,e.y-6,e.w*(e.hp/e.maxHp),4);
  });

  hp.innerText = Math.round(player.hp)+'/'+player.maxHp;
  mp.innerText = Math.round(player.mp)+'/'+player.maxMp;
  atk.innerText = player.atk;
  gold.innerText = gold;
  exp.innerText = player.exp;
  lv.innerText = player.lv;
}

// ================= ä¸»è¿´åœˆ =================
function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}

// ================= è¼¸å…¥ =================
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key === ' ') attack();
  if(e.key === 'e') interact();
  if(e.key >= '1' && e.key <= '3') castSkill(Number(e.key));
});
window.addEventListener('keyup',e=>{
  keys[e.key.toLowerCase()] = false;
});

// ================= å°è©± =================
let dialogQueue=[];
function showDialog(lines){
  dialogQueue=[...lines];
  dialogText.innerText=dialogQueue.shift();
  dialogBox.style.display='block';
}
function nextDialog(){
  if(dialogQueue.length===0){
    dialogBox.style.display='none';
    return;
  }
  dialogText.innerText=dialogQueue.shift();
}

// ================= å•Ÿå‹• =================
load();
changeArea('village');
loop();
</script>
</body>
</html>
