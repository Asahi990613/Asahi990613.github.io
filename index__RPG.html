<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG Final</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px;font-size:14px}
#regionMenu{position:fixed;right:10px;top:10px;background:#111;padding:8px;border-radius:6px}
#dialogBox,#shopUI,#questUI{
position:fixed;left:50%;top:50%;
transform:translate(-50%,-50%);
background:#111;padding:12px;border-radius:8px;display:none}
button{cursor:pointer}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP <span id="hp"></span>
MP <span id="mp"></span>
ATK <span id="atk"></span><br>
G <span id="goldSpan"></span>
EXP <span id="exp"></span>
LV <span id="lv"></span><br>
任務：<span id="questText">無</span>
</div>

<div id="regionMenu">
<b>區域</b><br>
<button onclick="changeArea('village')">村莊</button>
<button onclick="changeArea('forest')">森林</button>
<button onclick="changeArea('desert')">沙漠</button>
<button onclick="changeArea('swamp')">沼澤</button>
<button onclick="changeArea('dungeon')">地城</button>
</div>

<div id="shopUI"></div>
<div id="questUI"></div>

<script>
/* ===== 基本 ===== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let keys={};

const player={
x:480,y:300,w:18,h:18,
hp:120,maxHp:120,
mp:60,maxMp:60,mpRegen:0.15,
atk:6,lv:1,exp:0,expNext:100,
speed:2,isMember:false
};
let gold=30;

/* ===== 區域 ===== */
const AREAS={
village:{
key:'village',color:'#bda78a',
buildings:[
{x:160,y:200,w:120,h:70,type:'shop'},
{x:360,y:180,w:160,h:90,type:'guild'}
]
},
forest:{key:'forest',color:'#123a1a'},
desert:{key:'desert',color:'#d8c98a'},
swamp:{key:'swamp',color:'#234a2c'},
dungeon:{key:'dungeon',color:'#2a2a2a'},

shop_in:{
key:'shop_in',color:'#3a2f24',
counter:{x:260,y:180,w:200,h:30},
exit:{x:430,y:420,w:100,h:40},
npcs:[
{x:300,y:150,name:'武器店員',role:'weapon'},
{x:420,y:150,name:'藥水店員',role:'potion'}
]
},

guild_in:{
key:'guild_in',color:'#2f2f3a',
counter:{x:260,y:180,w:200,h:30},
exit:{x:430,y:420,w:100,h:40},
npcs:[
{x:360,y:150,name:'公會接待員',role:'guild'}
]
}
};

let currentArea=AREAS.village;

/* ===== 怪物 ===== */
const MONS=[
{name:'史萊姆',hp:20,atk:2,c:'#5af'},
{name:'哥布林',hp:35,atk:4,c:'#6a4'},
{name:'半獸人',hp:70,atk:8,c:'#a63'},
{name:'蜥人',hp:50,atk:6,c:'#3a8'},
{name:'鬼',hp:90,atk:10,c:'#aaa'}
];
const BOSS={name:'深淵鬼王',hp:400,atk:24,c:'#b22'};
let enemies=[];

function spawnEnemies(){
enemies=[];
if(currentArea.key.includes('in')||currentArea.key==='village')return;
let n=currentArea.key==='dungeon'?6:4;
for(let i=0;i<n;i++){
let m=MONS[Math.floor(Math.random()*MONS.length)];
enemies.push({
x:Math.random()*860+40,y:Math.random()*420+40,
w:20,h:20,
hp:m.hp,maxHp:m.hp,atk:m.atk,name:m.name,c:m.c
});
}
if(currentArea.key==='dungeon')
enemies.push({
x:450,y:120,w:40,h:40,
hp:BOSS.hp,maxHp:BOSS.hp,atk:BOSS.atk,
name:BOSS.name,c:BOSS.c,boss:true
});
}

/* ===== 技能（完全保留） ===== */
const SKILLS={
1:{name:'地獄業火',mp:12,dmg:30},
2:{name:'深海咒潮',mp:10,dmg:24},
3:{name:'烈風斷章',mp:8,dmg:20},
4:{name:'大地裁決',mp:14,dmg:36},
5:{name:'聖焰審判',mp:20,dmg:60},
6:{name:'破滅黯影',mp:18,dmg:55}
};

function castSkill(k){
let s=SKILLS[k];
if(!s||player.mp<s.mp)return;
player.mp-=s.mp;
enemies.forEach(e=>{
let d=Math.hypot(e.x-player.x,e.y-player.y);
if(d<160){e.hp-=s.dmg;if(e.hp<=0)killEnemy(e);}
});
}

/* ===== 任務 ===== */
const QUESTS={
E:{t:'史萊姆',c:3,r:30},
D:{t:'哥布林',c:5,r:60},
C:{t:'半獸人',c:5,r:120},
B:{t:'蜥人',c:3,r:200},
A:{t:'鬼',c:3,r:300},
S:{t:'深淵鬼王',c:1,r:1000}
};
let quest=null,qCount=0;

/* ===== 公會（重點） ===== */
function openGuild(){
let h='<h3>冒險者公會</h3>';
if(!player.isMember){
h+=`
<p>公會接待員：<br>
歡迎來到冒險者公會，請問要註冊成為會員嗎？</p>
<button onclick="registerMember()">註冊會員</button>`;
}else{
h+=`
<p>公會接待員：<br>
你已成為會員，今天要接什麼任務呢？</p>`;
for(let k in QUESTS){
h+=`[${k}] 打倒 ${QUESTS[k].c} ${QUESTS[k].t}
<button onclick="acceptQuest('${k}')">接</button><br>`;
}}
h+=`<br><button onclick="questUI.style.display='none'">關閉</button>`;
questUI.innerHTML=h;
questUI.style.display='block';
}

function registerMember(){
player.isMember=true;
openGuild();
}

function acceptQuest(k){
quest=QUESTS[k];qCount=0;
questText.innerText=`${quest.t} (${qCount}/${quest.c})`;
}

/* ===== 商店 ===== */
const SHOP=[
{name:'木劍',atk:2,price:20},
{name:'青銅劍',atk:6,price:80},
{name:'鐵劍',atk:12,price:200}
];
function openWeaponShop(){
let h='<h3>武器店</h3>';
SHOP.forEach(i=>{
h+=`${i.name} ATK+${i.atk} ${i.price}G
<button onclick="buyWeapon(${i.atk},${i.price})">買</button><br>`;
});
h+='<button onclick="shopUI.style.display=\'none\'">關閉</button>';
shopUI.innerHTML=h;shopUI.style.display='block';
}
function buyWeapon(atk,p){
if(gold<p)return;
gold-=p;player.atk=atk;
}
function openPotionShop(){
shopUI.innerHTML=
`<h3>藥水店</h3>
<button onclick="buyPotion('hp')">HP藥水 20G</button><br>
<button onclick="buyPotion('mp')">MP藥水 20G</button><br>
<button onclick="shopUI.style.display='none'">關閉</button>`;
shopUI.style.display='block';
}
function buyPotion(t){
if(gold<20)return;
gold-=20;
if(t==='hp')player.hp=Math.min(player.maxHp,player.hp+40);
if(t==='mp')player.mp=Math.min(player.maxMp,player.mp+30);
}

/* ===== 互動 ===== */
function interact(){
if(currentArea.key==='village'){
for(let b of currentArea.buildings){
if(Math.hypot(player.x-b.x,player.y-b.y)<60){
changeArea(b.type==='shop'?'shop_in':'guild_in');return;
}}}
if(currentArea.exit &&
Math.hypot(player.x-currentArea.exit.x,player.y-currentArea.exit.y)<50){
changeArea('village');return;
}
if(currentArea.npcs){
currentArea.npcs.forEach(n=>{
if(Math.hypot(player.x-n.x,player.y-n.y)<40){
if(n.role==='guild')openGuild();
if(n.role==='weapon')openWeaponShop();
if(n.role==='potion')openPotionShop();
}});
}

/* ===== 敵人死亡 ===== */
function killEnemy(e){
gold+=10;player.exp+=10;
if(quest&&e.name===quest.t){
qCount++;
questText.innerText=`${quest.t} (${qCount}/${quest.c})`;
if(qCount>=quest.c){
gold+=quest.r;quest=null;questText.innerText='完成';
}}
enemies=enemies.filter(x=>x!==e);
}

/* ===== 更新 / 繪製 ===== */
function update(){
if(keys.w)player.y-=player.speed;
if(keys.s)player.y+=player.speed;
if(keys.a)player.x-=player.speed;
if(keys.d)player.x+=player.speed;
player.mp=Math.min(player.maxMp,player.mp+player.mpRegen);
enemies.forEach(e=>{
let dx=player.x-e.x,dy=player.y-e.y;
let d=Math.hypot(dx,dy);
if(d>1){e.x+=dx/d*0.3;e.y+=dy/d*0.3;}
if(d<20)player.hp-=0.1;
});
}

function render(){
ctx.fillStyle=currentArea.color;
ctx.fillRect(0,0,960,540);

if(currentArea.buildings){
currentArea.buildings.forEach(b=>{
ctx.fillStyle='#654';
ctx.fillRect(b.x,b.y,b.w,b.h);
});
}

if(currentArea.counter){
ctx.fillStyle='#222';
ctx.fillRect(currentArea.counter.x,currentArea.counter.y,
currentArea.counter.w,currentArea.counter.h);
}

if(currentArea.exit){
ctx.fillStyle='#000';
ctx.fillRect(currentArea.exit.x,currentArea.exit.y,
currentArea.exit.w,currentArea.exit.h);
}

if(currentArea.npcs){
currentArea.npcs.forEach(n=>{
ctx.fillStyle='#ddd';
ctx.fillRect(n.x,n.y,14,18);
ctx.fillStyle='#fff';
ctx.fillText(n.name,n.x-10,n.y-6);
});
}

ctx.fillStyle='#fff';
ctx.fillRect(player.x,player.y,player.w,player.h);

enemies.forEach(e=>{
ctx.fillStyle=e.c;
ctx.fillRect(e.x,e.y,e.w,e.h);
ctx.fillStyle='#f00';
ctx.fillRect(e.x,e.y-4,e.w*(e.hp/e.maxHp),3);
});

hp.innerText=`${Math.floor(player.hp)}/${player.maxHp}`;
mp.innerText=Math.floor(player.mp);
atk.innerText=player.atk;
goldSpan.innerText=gold;
exp.innerText=player.exp;
lv.innerText=player.lv;
}

function loop(){update();render();requestAnimationFrame(loop);}
function changeArea(k){currentArea=AREAS[k];spawnEnemies();}
requestAnimationFrame(loop);

window.onkeydown=e=>{
keys[e.key.toLowerCase()]=true;
if(e.key>='1'&&e.key<='6')castSkill(e.key);
if(e.key==='e')interact();
};
window.onkeyup=e=>keys[e.key.toLowerCase()]=false;
</script>
</body>
</html>
