<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG Project</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#111;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px;font-size:14px}
#mapUI{
 position:fixed;right:10px;top:10px;
 background:#111;padding:8px;border-radius:6px
}
#help{
 position:fixed;left:10px;bottom:10px;
 background:rgba(0,0,0,0.6);
 padding:8px;border-radius:6px;
 font-size:13px
}
button{margin:2px}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP:<span id="hp"></span>
MP:<span id="mp"></span>
Gold:<span id="gold"></span>
</div>

<div id="mapUI">
<b>地區</b><br>
<button onclick="changeScene('village')">村莊</button>
<button onclick="changeScene('forest')">森林</button>
</div>

<div id="help">
WASD：移動<br>
E：互動 / 進門<br>
Space：普攻<br>
1~3：技能<br>
Z：包包
</div>

<script>
/* ========= 基本 ========= */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let keys={};
let scene="village";

/* ========= 玩家 ========= */
const player={
 x:460,y:320,w:20,h:28,
 hp:100,maxHp:100,
 mp:50,maxMp:50,
 atk:6,def:0,speed:2
};
let gold=30;

/* ========= 建築（村莊） ========= */
const buildings={
 guild:{x:300,y:180,w:180,h:140,name:"冒險者公會"},
 shop:{x:520,y:200,w:160,h:120,name:"商店"}
};

/* ========= 地區切換 ========= */
function changeScene(s){
 scene=s;
 if(scene==="village"){
  player.x=460;player.y=320;
 }
 if(scene==="forest"){
  player.x=120;player.y=260;
 }
}

/* ========= 更新 ========= */
function update(){
 if(keys.w)player.y-=player.speed;
 if(keys.s)player.y+=player.speed;
 if(keys.a)player.x-=player.speed;
 if(keys.d)player.x+=player.speed;

 player.x=Math.max(0,Math.min(canvas.width-player.w,player.x));
 player.y=Math.max(0,Math.min(canvas.height-player.h,player.y));
}

/* ========= 繪製 ========= */
function drawPlayer(){
 ctx.fillStyle="#f2c9ac";
 ctx.fillRect(player.x+6,player.y,8,8);
 ctx.fillStyle="#3a6ee8";
 ctx.fillRect(player.x+4,player.y+8,12,10);
 ctx.fillStyle="#222";
 ctx.fillRect(player.x+4,player.y+18,4,8);
 ctx.fillRect(player.x+12,player.y+18,4,8);
}

function drawBuilding(b){
 ctx.fillStyle="#6b4";
 ctx.fillRect(b.x,b.y,b.w,b.h);
 ctx.fillStyle="#000";
 ctx.fillRect(b.x+b.w/2-12,b.y+b.h-24,24,24); // 門
 ctx.fillStyle="#fff";
 ctx.fillText(b.name,b.x+10,b.y+18);
}

function render(){
 /* 背景 */
 ctx.fillStyle = scene==="village" ? "#bda78a" : "#103814";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 /* 建築只在村莊 */
 if(scene==="village"){
  drawBuilding(buildings.guild);
  drawBuilding(buildings.shop);
 }

 drawPlayer();

 hp.innerText=Math.round(player.hp);
 mp.innerText=Math.round(player.mp);
 gold.innerText=gold;
}

/* ========= 互動 ========= */
function interact(){
 if(scene!=="village")return;

 for(const k in buildings){
  const b=buildings[k];
  const d=Math.hypot(
   player.x-(b.x+b.w/2),
   player.y-(b.y+b.h)
  );
  if(d<40){
   alert(b.name+"（第 2 段會進入室內）");
  }
 }
}

/* ========= 控制 ========= */
window.addEventListener("keydown",e=>{
 keys[e.key.toLowerCase()]=true;
 if(e.key.toLowerCase()==="e")interact();
});
window.addEventListener("keyup",e=>{
 keys[e.key.toLowerCase()]=false;
});

/* ========= 主迴圈 ========= */
(function loop(){
 update();
 render();
 requestAnimationFrame(loop);
})();
/* ===========================
   室內場景系統（修正版）
=========================== */

let indoor = null; // null / "guild" / "shop"

/* 進入室內 */
function enterIndoor(type){
 indoor = type;
 player.x = canvas.width/2 - 10;
 player.y = canvas.height - 80;
}

/* 離開室內 */
function exitIndoor(){
 indoor = null;
 scene = "village";
 player.x = 460;
 player.y = 360;
}

/* 覆寫互動 */
function interact(){
 if(indoor){
  // 出口門
  if(player.y > canvas.height - 100){
   exitIndoor();
  }
  return;
 }

 if(scene === "village"){
  for(const k in buildings){
   const b = buildings[k];
   const d = Math.hypot(
    player.x-(b.x+b.w/2),
    player.y-(b.y+b.h)
   );
   if(d < 40){
    enterIndoor(k);
   }
  }
 }
}

/* 室內繪製 */
function drawIndoor(){
 ctx.fillStyle = indoor === "guild" ? "#2c3e50" : "#3a2c1f";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 // 櫃檯
 ctx.fillStyle="#654";
 ctx.fillRect(canvas.width/2-120,120,240,40);

 // NPC
 ctx.fillStyle="#f2c9ac";
 ctx.fillRect(canvas.width/2-10,80,20,30);

 ctx.fillStyle="#fff";
 ctx.fillText(
  indoor==="guild"?"公會櫃檯":"商店店員",
  canvas.width/2-40,70
 );

 // 出口門
 ctx.fillStyle="#000";
 ctx.fillRect(canvas.width/2-20,canvas.height-40,40,40);
 ctx.fillText("出口",canvas.width/2-16,canvas.height-45);
}

/* ===========================
   MP 自動回復
=========================== */
setInterval(()=>{
 player.mp = Math.min(player.maxMp, player.mp + 1);
},1000);

/* ===========================
   怪物（森林）
=========================== */
const monsters=[
 {x:300,y:200,hp:30,maxHp:30,atk:3,speed:0.6,name:"哥布林",lv:1}
];

/* 怪物更新 */
function updateMonsters(){
 if(scene!=="forest" || indoor) return;

 monsters.forEach(m=>{
  const dx = player.x - m.x;
  const dy = player.y - m.y;
  const d = Math.hypot(dx,dy);

  if(d>1){
   m.x += dx/d * m.speed;
   m.y += dy/d * m.speed;
  }

  // 碰到玩家
  if(d<20){
   player.hp = Math.max(0, player.hp - m.atk*0.02);
  }
 });
}

/* 怪物繪製 */
function drawMonsters(){
 if(scene!=="forest" || indoor) return;

 monsters.forEach(m=>{
  ctx.fillStyle="#0f0";
  ctx.fillRect(m.x,m.y,20,20);

  // 血條
  ctx.fillStyle="#f00";
  ctx.fillRect(m.x,m.y-6,20*(m.hp/m.maxHp),4);

  ctx.fillStyle="#fff";
  ctx.fillText(`${m.name} Lv.${m.lv}`,m.x-10,m.y-10);
 });
}

/* ===========================
   覆寫 render
=========================== */
const oldRender = render;
render = function(){
 if(indoor){
  drawIndoor();
  drawPlayer();
 }else{
  oldRender();
  drawMonsters();
 }
};

/* ===========================
   覆寫 update
=========================== */
const oldUpdate = update;
update = function(){
 if(!indoor) oldUpdate();
 updateMonsters();
};
</script>
</body>
</html>
