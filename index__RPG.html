<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG Final Complete</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px;font-size:14px}
#regionMenu{position:fixed;right:10px;top:10px;background:#111;padding:8px;border-radius:6px}
#dialogBox{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
background:rgba(0,0,0,.85);padding:12px;border-radius:8px;width:70%;display:none}
#shopUI,#questUI{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
background:#111;padding:12px;border-radius:8px;display:none}
button{cursor:pointer}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP <span id="hp"></span> MP <span id="mp"></span> ATK <span id="atk"></span><br>
G <span id="gold"></span> EXP <span id="exp"></span> LV <span id="lv"></span><br>
任務：<span id="questText">無</span>
</div>

<div id="regionMenu">
<b>區域</b><br>
<button onclick="changeArea('village')">村莊</button>
<button onclick="changeArea('forest')">森林</button>
<button onclick="changeArea('desert')">沙漠</button>
<button onclick="changeArea('swamp')">沼澤</button>
<button onclick="changeArea('dungeon')">地城</button>
</div>

<div id="shopUI"></div>
<div id="questUI"></div>

<script>
/* ===== 基本 ===== */
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
let keys={};

const player={x:480,y:270,w:20,h:20,
hp:120,maxHp:120,mp:60,maxMp:60,mpRegen:0.15,
atk:6,lv:1,exp:0,expNext:100,speed:2,isMember:false};
let gold=30;

/* ===== 區域 ===== */
const AREAS={
village:{key:'village',color:'#bda78a',
buildings:[
{x:120,y:200,w:120,h:70,type:'shop',name:'商店',door:{x:165,y:250,w:30,h:20}},
{x:320,y:180,w:160,h:90,type:'guild',name:'冒險者公會',door:{x:390,y:260,w:30,h:20}}
]},
forest:{key:'forest',color:'#123a1a'},
desert:{key:'desert',color:'#d8c98a'},
swamp:{key:'swamp',color:'#234a2c'},
dungeon:{key:'dungeon',color:'#2a2a2a'},

shop_in:{key:'shop_in',color:'#3a2f24',
counter:{x:260,y:170,w:200,h:28},
exit:{x:440,y:380,w:80,h:30},
npcs:[
{x:300,y:140,name:'武器店員',role:'weapon'},
{x:420,y:140,name:'藥水店員',role:'potion'}
]},

guild_in:{key:'guild_in',color:'#2f2f3a',
counter:{x:260,y:170,w:200,h:28},
exit:{x:440,y:380,w:80,h:30},
npcs:[{x:350,y:140,name:'公會接待',role:'guild'}]}
};
let currentArea=AREAS.village;

/* ===== 怪物 ===== */
const MONS=[
{name:'史萊姆',hp:20,atk:2,c:'#5af'},
{name:'哥布林',hp:35,atk:4,c:'#6a4'},
{name:'半獸人',hp:70,atk:8,c:'#a63'},
{name:'蜥人',hp:50,atk:6,c:'#3a8'},
{name:'鬼',hp:90,atk:10,c:'#aaa'}
];
const BOSS={name:'深淵鬼王',hp:400,atk:24,c:'#b22'};
let enemies=[];

function spawnEnemies(){
enemies=[];
if(currentArea.key.includes('in')||currentArea.key==='village')return;
let n=currentArea.key==='dungeon'?8:5;
for(let i=0;i<n;i++){
let m=MONS[Math.floor(Math.random()*MONS.length)];
enemies.push({x:Math.random()*860+40,y:Math.random()*420+40,
w:22,h:22,hp:m.hp,maxHp:m.hp,atk:m.atk,name:m.name,c:m.c});
}
if(currentArea.key==='dungeon')
enemies.push({x:450,y:120,w:48,h:48,hp:BOSS.hp,maxHp:BOSS.hp,
atk:BOSS.atk,name:BOSS.name,c:BOSS.c,boss:true});
}

/* ===== 技能（原樣保留） ===== */
const SKILLS={
1:{name:'地獄業火',mp:12,dmg:30},
2:{name:'深海咒潮',mp:10,dmg:24},
3:{name:'烈風斷章',mp:8,dmg:20},
4:{name:'大地裁決',mp:14,dmg:36},
5:{name:'聖焰審判',mp:20,dmg:60},
6:{name:'破滅黯影',mp:18,dmg:55}
};
function castSkill(k){
let s=SKILLS[k];
if(!s||player.mp<s.mp)return;
player.mp-=s.mp;
enemies.forEach(e=>{
if(Math.hypot(e.x-player.x,e.y-player.y)<160){
e.hp-=s.dmg;if(e.hp<=0)killEnemy(e);
}});
}

/* ===== 商店 ===== */
const SHOP=[
{name:'木劍',atk:2,price:20},
{name:'青銅劍',atk:6,price:80},
{name:'鐵劍',atk:12,price:200},
{name:'勇者之刃',atk:28,price:600}
];
const POTIONS=[
{name:'小型治療藥水',type:'hp',value:30,price:20},
{name:'小型魔力藥水',type:'mp',value:20,price:20}
];

function openWeaponShop(){
let h='<h3>武器櫃台</h3>';
SHOP.forEach(i=>{
h+=`${i.name} ATK+${i.atk} ${i.price}G 
<button onclick="buyWeapon('${i.name}')">買</button><br>`;
});
h+='<button onclick="shopUI.style.display=\'none\'">關閉</button>';
shopUI.innerHTML=h;shopUI.style.display='block';
}
function buyWeapon(n){
let i=SHOP.find(x=>x.name===n);
if(!i||gold<i.price)return;
gold-=i.price;player.atk=i.atk;
}

function openPotionShop(){
let h='<h3>藥水櫃台</h3>';
POTIONS.forEach(p=>{
h+=`${p.name} ${p.price}G 
<button onclick="buyPotion('${p.name}')">買</button><br>`;
});
h+='<button onclick="shopUI.style.display=\'none\'">關閉</button>';
shopUI.innerHTML=h;shopUI.style.display='block';
}
function buyPotion(n){
let p=POTIONS.find(x=>x.name===n);
if(!p||gold<p.price)return;
gold-=p.price;
if(p.type==='hp')player.hp=Math.min(player.maxHp,player.hp+p.value);
if(p.type==='mp')player.mp=Math.min(player.maxMp,player.mp+p.value);
}

/* ===== 公會 / 任務 ===== */
const QUESTS={
E:{t:'史萊姆',c:3,r:30},
D:{t:'哥布林',c:5,r:60},
C:{t:'半獸人',c:5,r:120},
B:{t:'蜥人',c:3,r:200},
A:{t:'鬼',c:3,r:300},
S:{t:'深淵鬼王',c:1,r:1000}
};
let quest=null,qCount=0;

function openGuild(){
let h='<h3>冒險者公會</h3>';
if(!player.isMember){
h+='<button onclick="player.isMember=true">註冊會員</button>';
}else{
for(let k in QUESTS){
h+=`[${k}] 打倒 ${QUESTS[k].c} ${QUESTS[k].t}
<button onclick="acceptQuest('${k}')">接</button><br>`;
}}
h+='<button onclick="questUI.style.display=\'none\'">關閉</button>';
questUI.innerHTML=h;questUI.style.display='block';
}
function acceptQuest(k){
quest=QUESTS[k];qCount=0;
questText.innerText=`${quest.t} (${qCount}/${quest.c})`;
}

/* ===== 敵人死亡 ===== */
function killEnemy(e){
gold+=10;player.exp+=10;
if(quest&&e.name===quest.t){
qCount++;
questText.innerText=`${quest.t} (${qCount}/${quest.c})`;
if(qCount>=quest.c){
gold+=quest.r;quest=null;questText.innerText='完成';
}}
enemies=enemies.filter(x=>x!==e);
}

/* ===== 互動 ===== */
function interact(){
if(currentArea.buildings){
for(let b of currentArea.buildings){
let d=b.door;
if(Math.hypot(player.x-d.x,player.y-d.y)<40){
changeArea(b.type==='shop'?'shop_in':'guild_in');return;
}}}
if(currentArea.exit &&
Math.hypot(player.x-currentArea.exit.x,player.y-currentArea.exit.y)<50){
changeArea('village');return;
}
if(currentArea.npcs){
for(let n of currentArea.npcs){
if(Math.hypot(player.x-n.x,player.y-n.y)<40){
if(n.role==='weapon')openWeaponShop();
if(n.role==='potion')openPotionShop();
if(n.role==='guild')openGuild();
}}}
}

/* ===== 更新 / 繪製 ===== */
function update(){
if(keys.w)player.y-=player.speed;
if(keys.s)player.y+=player.speed;
if(keys.a)player.x-=player.speed;
if(keys.d)player.x+=player.speed;
player.mp=Math.min(player.maxMp,player.mp+player.mpRegen);
enemies.forEach(e=>{
let dx=player.x-e.x,dy=player.y-e.y,d=Math.hypot(dx,dy);
if(d>1){e.x+=dx/d*0.3;e.y+=dy/d*0.3;}
});
}

function render(){
ctx.fillStyle=currentArea.color;
ctx.fillRect(0,0,960,540);

if(currentArea.buildings){
currentArea.buildings.forEach(b=>{
ctx.fillStyle='#654';ctx.fillRect(b.x,b.y,b.w,b.h);
ctx.fillStyle='#000';ctx.fillRect(b.door.x,b.door.y,b.door.w,b.door.h);
ctx.fillStyle='#000';ctx.fillText(b.name,b.x+6,b.y+14);
});
}
if(currentArea.counter){
ctx.fillStyle='#222';
ctx.fillRect(currentArea.counter.x,currentArea.counter.y,
currentArea.counter.w,currentArea.counter.h);
}
if(currentArea.exit){
ctx.fillStyle='#000';
ctx.fillRect(currentArea.exit.x,currentArea.exit.y,
currentArea.exit.w,currentArea.exit.h);
}

if(currentArea.npcs){
currentArea.npcs.forEach(n=>{
ctx.fillStyle='#ddd';
ctx.fillRect(n.x,n.y,14,18);
ctx.fillStyle='#fff';
ctx.fillText(n.name,n.x-6,n.y-6);
});
}

ctx.fillStyle='#fff';
ctx.fillRect(player.x,player.y,player.w,player.h);

enemies.forEach(e=>{
ctx.fillStyle=e.c;ctx.fillRect(e.x,e.y,e.w,e.h);
ctx.fillStyle='#f00';
ctx.fillRect(e.x,e.y-4,e.w*(e.hp/e.maxHp),3);
});

hp.innerText=`${Math.floor(player.hp)}/${player.maxHp}`;
mp.innerText=Math.floor(player.mp);
atk.innerText=player.atk;
gold.innerText=gold;
exp.innerText=player.exp;
lv.innerText=player.lv;
}

function loop(){update();render();requestAnimationFrame(loop);}
function changeArea(k){currentArea=AREAS[k];spawnEnemies();}
requestAnimationFrame(loop);

window.onkeydown=e=>{
keys[e.key.toLowerCase()]=true;
if(e.key>='1'&&e.key<='6')castSkill(e.key);
if(e.key==='e')interact();
};
window.onkeyup=e=>keys[e.key.toLowerCase()]=false;
</script>
</body>
</html>
