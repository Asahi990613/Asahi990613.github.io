<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>Pixel RPG Interior System</title>
<style>
body{margin:0;background:#070707;color:#fff;font-family:monospace}
canvas{display:block;margin:0 auto;background:#000;image-rendering:pixelated}
#ui{position:fixed;left:10px;top:10px}
#panel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
background:#111;padding:12px;border-radius:8px;display:none}
button{cursor:pointer}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>

<div id="ui">
HP:<span id="hp"></span>
MP:<span id="mp"></span>
ATK:<span id="atk"></span><br>
Gold:<span id="gold"></span>
LV:<span id="lv"></span><br>
Quest:<span id="questText">無</span>
</div>

<div id="panel"></div>

<script>
const c=document.getElementById("game");
const ctx=c.getContext("2d");
let keys={};

// ================= 玩家 =================
const player={
 x:480,y:360,w:20,h:28,
 hp:120,maxHp:120,
 mp:60,maxMp:60,
 atk:8,lv:1,exp:0,
 speed:2
};
let gold=50;

// ================= 地圖狀態 =================
let scene="village"; // village / guildInterior / forest

// ================= 任務 =================
const QUESTS=[
 {name:"清除史萊姆",target:"史萊姆",count:3,reward:{gold:30,exp:20}},
 {name:"討伐哥布林",target:"哥布林",count:4,reward:{gold:50,exp:40}},
 {name:"擊殺蜥人",target:"蜥人",count:3,reward:{gold:80,exp:70}}
];
let currentQuest=null,progress=0,completed=false;

// ================= 怪物 =================
let enemies=[];
function spawnEnemies(){
 enemies=[];
 if(scene==="forest"){
  enemies.push(
   {name:"史萊姆",lv:1,hp:20,maxHp:20,atk:2,x:200,y:200,c:"#5af"},
   {name:"哥布林",lv:2,hp:35,maxHp:35,atk:4,x:350,y:250,c:"#6a4"},
   {name:"蜥人",lv:3,hp:50,maxHp:50,atk:6,x:500,y:220,c:"#3a8"}
  );
 }
}

// ================= 技能 =================
const SKILLS={
 1:{name:"火焰斬",mp:10,dmg:30,color:"orange"},
 2:{name:"雷擊",mp:15,dmg:45,color:"yellow"},
 3:{name:"聖光",mp:20,dmg:65,color:"white"}
};
let effects=[];

// ================= 繪製 =================
function drawVillage(){
 ctx.fillStyle="#bda78a";ctx.fillRect(0,0,c.width,c.height);
 // 公會外觀
 ctx.fillStyle="#555";ctx.fillRect(300,150,260,200);
 ctx.fillStyle="#222";ctx.fillRect(410,300,40,50); // door
 ctx.fillText("冒險者公會",360,145);
}
function drawGuildInterior(){
 ctx.fillStyle="#2b2b3d";ctx.fillRect(0,0,c.width,c.height);
 // counter
 ctx.fillStyle="#444";ctx.fillRect(300,220,360,60);
 ctx.fillStyle="#ccc";ctx.fillRect(440,180,20,40); // npc
 ctx.fillText("公會櫃檯",430,170);
}
function drawForest(){
 ctx.fillStyle="#103814";ctx.fillRect(0,0,c.width,c.height);
}
function drawPlayer(){
 ctx.fillStyle="#f2c9ac";ctx.fillRect(player.x+6,player.y,8,8);
 ctx.fillStyle="#3a6ee8";ctx.fillRect(player.x+4,player.y+8,12,10);
 ctx.fillStyle="#222";
 ctx.fillRect(player.x+4,player.y+18,4,8);
 ctx.fillRect(player.x+12,player.y+18,4,8);
}

// ================= 戰鬥 =================
function attack(){
 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<40){
   e.hp-=player.atk;
   effects.push({type:"slash",x:e.x,y:e.y,t:0});
   if(e.hp<=0)kill(e);
  }
 });
}
function cast(i){
 const s=SKILLS[i];
 if(!s||player.mp<s.mp)return;
 player.mp-=s.mp;
 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<120){
   e.hp-=s.dmg;
   effects.push({type:s.name,x:e.x,y:e.y,t:0});
   if(e.hp<=0)kill(e);
  }
 });
}
function kill(e){
 if(currentQuest && e.name===currentQuest.target){
  progress++;
  if(progress>=currentQuest.count){
   completed=true;
   questText.innerText="任務完成";
  }
 }
 gold+=10;
 enemies=enemies.filter(x=>x!==e);
}

// ================= 任務 UI =================
function openGuildUI(){
 let html="<h3>公會任務</h3>";
 QUESTS.forEach((q,i)=>{
  html+=`${q.name} <button onclick="accept(${i})">接受</button><br>`;
 });
 if(completed){
  html+=`<button onclick="claim()">領取報酬</button>`;
 }
 html+=`<br><button onclick="closePanel()">關閉</button>`;
 panel.innerHTML=html;
 panel.style.display="block";
}
function accept(i){
 currentQuest=QUESTS[i];
 progress=0;completed=false;
 questText.innerText=currentQuest.name;
 closePanel();
}
function claim(){
 gold+=currentQuest.reward.gold;
 player.exp+=currentQuest.reward.exp;
 currentQuest=null;completed=false;
 questText.innerText="無";
 closePanel();
}
function closePanel(){panel.style.display="none";}

// ================= 更新 =================
function update(){
 if(keys.w)player.y-=player.speed;
 if(keys.s)player.y+=player.speed;
 if(keys.a)player.x-=player.speed;
 if(keys.d)player.x+=player.speed;

 enemies.forEach(e=>{
  if(Math.hypot(player.x-e.x,player.y-e.y)<24){
   player.hp-=e.atk*0.05;
  }
 });
 player.hp=Math.max(0,player.hp);

 effects.forEach(f=>f.t+=0.1);
 effects=effects.filter(f=>f.t<1);
}

// ================= 繪製 =================
function render(){
 if(scene==="village")drawVillage();
 if(scene==="guildInterior")drawGuildInterior();
 if(scene==="forest")drawForest();

 drawPlayer();

 enemies.forEach(e=>{
  ctx.fillStyle=e.c;ctx.fillRect(e.x,e.y,22,22);
  ctx.fillStyle="#f33";
  ctx.fillRect(e.x,e.y-6,22*(e.hp/e.maxHp),4);
  ctx.fillStyle="#fff";
  ctx.fillText(`${e.name} Lv${e.lv}`,e.x-10,e.y-10);
 });

 effects.forEach(f=>{
  ctx.globalAlpha=1-f.t;
  ctx.fillStyle=f.type==="slash"?"#fff":"orange";
  ctx.beginPath();
  ctx.arc(f.x+10,f.y+10,40*f.t,0,Math.PI*2);
  ctx.fill();
  ctx.globalAlpha=1;
 });

 hp.innerText=Math.round(player.hp);
 mp.innerText=Math.round(player.mp);
 atk.innerText=player.atk;
 gold.innerText=gold;
 lv.innerText=player.lv;
}

// ================= 互動 =================
function interact(){
 if(scene==="village"){
  if(Math.hypot(player.x-430,player.y-320)<40){
   scene="guildInterior";
   player.x=460;player.y=400;
  }
 }
 else if(scene==="guildInterior"){
  if(Math.hypot(player.x-450,player.y-200)<40){
   openGuildUI();
  }
  if(player.y>500){
   scene="village";
   player.x=420;player.y=360;
  }
 }
}

// ================= 控制 =================
window.addEventListener("keydown",e=>{
 keys[e.key]=true;
 if(e.key===" ")attack();
 if(e.key>="1"&&e.key<="3")cast(Number(e.key));
 if(e.key==="e")interact();
});
window.addEventListener("keyup",e=>keys[e.key]=false);

// ================= 主迴圈 =================
function loop(){update();render();requestAnimationFrame(loop);}
spawnEnemies();
loop();
</script>
</body>
</html>

